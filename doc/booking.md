# Запрос

## Создание запроса

После создания запроса пользователем:

- запрос переводится в состояние ``AbRequest::BOOKING_STATUS_NOT_VERIFIED``.
- отсылается письмо на ``ContactEmail`` (указанный в запросе), и на адрес букера. 
- в отсылаемом на ``ContactEmail`` письме присутствует ссылка подтверждения емейла.
- пользователь переходит на страницу просмотра запроса.

## Изменение запроса

Если в процессе измения запроса пользователем, изменился ``ContactEmail``, запрос переводится в состояние ``AbRequest::BOOKING_STATUS_NOT_VERIFIED``, независимо от предыдущего состояния. На новый ``ContactEmail`` высылается письмо, со ссылкой подтверждения емейла. 
Если ``ContactEmail`` остался старым, состояние запроса не меняется. 

## Просмотр запроса

### Подтверждение емейла

Когда запрос находится в состоянии ``AbRequest::BOOKING_STATUS_NOT_VERIFIED``, поверх страницы просмотра запроса отображается попап подтверждения контактного емейла. Пользователь не может закрыть этот попап.

В попапе подтверждения контактного емейла доступны два действия:

- переход на изменение запроса (если нужно поменять ``ContactEmail``). 
- кнопка отсылки нового письма со ссылкой подтверждения емейла. 

При переходе по ссылке подтверждения емейла из письма, запрос переводится в состояние ``AbRequest::BOOKING_STATUS_PENDING``, и попап больше не отображается.

## Состояния запроса



## Переписка



## Особенности букера

После создания запроса букером:

- запрос переводится в состояние ``AbRequest::BOOKING_STATUS_PENDING`` (то есть подтверждение емейла не требуется).
- письма не отсылаются. 

Букер может закрыть попап подтверждения контактного емейла.

# Список запросов

## Пользователь

Список запросов пользователя разбит на две части:

* Архив запросов -- запросы в состояниях ``AbRequest::BOOKING_STATUS_CANCELED`` и ``AbRequest::BOOKING_STATUS_BOOKED``.
* Активные запросы -- запросы в прочих состояниях.

При переходе в раздел букинга открывается список активных запросов. Если активный запрос только один -- открывается страница просмотра этого запроса.

Интерфейс списков идентичен:

* пользовательских сортировок нет, сортируется по дате добавления в обратном порядке.
* пользовательских фильтров нет.
* список разбит на страницы.
* запросы с непрочитанными сообщениями выделяются шрифтом (bold).
* кнопка "ответить" ведёт на страницу просмотра запроса, к форме добавления сообщения.
* кнопка "пометить как прочитанное / не прочитанное" меняет состояние прочитанности сообщений в запросе.

## Букер

> ~~В списке запросов букера по умолчанию не отображаются запросы в состоянии ``AbRequest::BOOKING_STATUS_NOT_VERIFIED``.
Чтобы просмотреть список запросов в состоянии ``AbRequest::BOOKING_STATUS_NOT_VERIFIED``, букер должен использовать фильтр состояний. 

Это отменено. 

# Счета и оплата

## Букер

## Пользователь

# Шаринг



# Письма

## Новый запрос

Высылается только при создании запроса пользователем. При создании запроса букером письмо не высылается.
Высылается на ``ContactEmail`` запроса и на адрес букера.
В письме, высылаемом на ``ContactEmail``, присутствует ссылка подтверждения емейла.

## Повторное подтверждение емейла

Высылается при нажатии на кнопку в попапе подтверждения емейла.
Высылается на ``ContactEmail`` запроса.
Идентично письму "Новый запрос".  

## Изменение запроса

Высылается только при изменении запроса пользователем.
Высылается на ``ContactEmail`` запроса и на адрес букера.
Если запрос находится в состоянии ``AbRequest::BOOKING_STATUS_NOT_VERIFIED``, в письме, высылаемом на ``ContactEmail``, присутствует ссылка подтверждения емейла.

## ...

... тут ещё пачка писем ...

# Принадлежность пользователей 

## Поля в БД

`Usr`:

- `OwnedByBusinessID` -- пользователя привёл букер
- `DefaultBookerID` -- используемый пользователем букер по умолчанию

## Логика установки полей

`OwnedByBusinessID`:

- пользователь пришёл через Ref-ссылку букера, и зарегистрировался в AW 
- пользователь пришёл через приглашение на Email от любого админа букера (есть запись в таблице `Invites`), и зарегистрировался в AW 
- пользователь зарегистрировался с купоном любого админа букера (есть запись в таблице `Invites`)

Таким образом, `OwnedByBusinessID` задаётся только при регистрации, и в дальнейшем не меняется. 

`DefaultBookerID`:

- если установлен `OwnedByBusinessID` -- тогда всегда равен `OwnedByBusinessID`
- если не установлен `OwnedByBusinessID` -- тогда устанавливается в букера первого бук-запроса данного пользователя с заданной Ref-ссылкой
- если не установлен `OwnedByBusinessID` и у пользователя нет бук-запросов с заданной Ref-ссылкой -- остаётся `null`
- (для избранных) если пользователь является админом букера -- устанавливается в этого букера 

## Логика использования полей

Новый бук-запрос отправляется в очередь букера на основе следующих правил:

- Если на страницу добавления запроса перешли по Ref-ссылке букера -- то запрос отправляется букеру этой Ref-ссылки
- Если пользователь зарегистрирован и у него установлено поле принадлежности к бизнесу -- то запрос отправляется в очередь этого бизнеса 
- Если пользователь зарегистрирован и у него установлено поле букер по умолчанию -- то запрос отправляется букеру по умолчанию пользователя
- ~~Если пользователь не зарегистрирован или у него не установлено поле букер по умолчанию -- то запрос отправляется системному букеру по умолчанию~~ (отключено в https://redmine.awardwallet.com/issues/10320)
- Во всех остальных случаях используется выбор букера на основе формы добавления бук-запроса
    - Если в бук-запросе выбран EconomyClass -- запрос отправляется Abroaders
    - Если в бук-запросе не выбран EconomyClass -- запрос отправляется BYA

~~Системный букер по умолчанию -- BYA~~

Логотип раздела букинга устанавливается на основе следующих правил:

- Если на странице добавления, редактирования и просмотра бук-запроса -- на основе букера из этого бук-запроса
- На прочих страницах
    - Если у пользователя установлено поле `OwnedByBusinessID` -- то логотип букера из поля `OwnedByBusinessID`
    - Иначе -- логотип AW
- В бизнес-интерфейсе букера -- всегда логотип букера 
