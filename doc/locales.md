# Язык интерфейса

## Настройка

`app/config/config.yml`

- `locale`: **en** -- локаль по умолчанию
- `locales`: **['en', 'ru', 'pt', 'es', 'de']** -- поддерживаемые языки
- `public_locales_mobile`: **['en', 'ru', 'pt', 'es']** -- языки, доступные мобильным пользователям
- `public_locales_desktop`: **['en', 'ru']** -- языки, доступные декстопным пользователям
- `dump-locales`: **['en']** -- настройки для экстрактора
- `route_locales`: **'en|ru|pt|es|de'** -- используется в настройках роутинга, рекомендуется держать состав языков идентичным `locales` (например, `@Route("/{_locale}/contact", name="aw_contactus_index_locale", defaults={"_locale"="en"}, requirements={"_locale" = "%route_locales%"})`)

## Разделение пользователей

- авторизованные пользователи в группе `TRANSLATORS` -- доступны все языки из `locales` 
- прочие авторизованные пользователи
	- мобильный интерфейс -- доступны языки только из `public_locales_mobile`
	- декстопный интерфейс -- доступны языки только из `public_locales_desktop`
- анонимные пользователи
	- мобильный интерфейс -- доступны языки только из `public_locales_mobile`
	- декстопный интерфейс -- доступны языки только из `public_locales_desktop`

## Определение языка интерфейса

- анонимные пользователи, десктоп
	- если нет языка в параметрах запроса (например `/page/about`) и не установлена кука -- выбирается автоматически, из настроек браузера; записывается в куку
	- если есть язык в параметрах запроса (например `/ru/page/about`) -- выбирается из параметра запроса; записывается в куку
	- в остальных случаях выбирается из куки 
- регистрация пользователей, десктоп 
	- при регистрации текущий язык пользователя (независимо от того, как он выбран) записывается в профиль пользователя, в поле `Usr.Language`
- авторизованные пользователи, десктоп 
	- если есть язык в параметрах запроса -- выбирается из параметра запроса; НЕ записывается в профиль
	- в остальных случаях выбирается из профиля пользователя 

Если пользователь пытается установить язык, ему недоступный, язык пользователя сбрасывается в значение по умолчанию -- см. `locale`

см. `/bundles/AwardWallet/MainBundle/FrameworkExtension/Listeners/LocaleListener.php`

## Изменение языка интерфейса

- анонимные пользователи, десктоп
	- параметр запроса `/ru/page/about`
	- переключалка языков `/ru/set_locale`
- авторизованные пользователи, десктоп 
	- переключалка языков `/ru/set_locale`
	- редактирование профиля `/user/regional`


# Форматирование дат и чисел (регион) 

Даты и числа форматируются согласно настройкам региона пользователя (поле `Usr.Region`).

Поле `Usr.Region` может содержать: 

- значение локали (например, **en_US**) -- тогда применяется выбранная локаль.
- пустое значение -- тогда локаль определяется на основе языка интерфейса пользователя ( **ru** -> **ru_RU**, **en** -> **en_US**, и тд )

Для анонимного пользователя локаль всегда определяется на основе языка интерфейса пользователя.

Правила определения локали по языку находятся в `LocalizeService::$language_to_locale`.

## API

Для форматирования используется сервис `aw.locale.localizer` (`/bundles/AwardWallet/MainBundle/Globals/Localizer/LocalizeService.php`).

- инициализация и настройки
	- `$language_to_locale` -- конфигурация локалей по умолчанию 
	- `setLocale($locale)`
	- `setUser($user)`
- стандартный `IntlDateFormatter` (см. http://php.net/manual/en/class.intldateformatter.php)
	- `formatDateTime($DateTime, $DateFormat = 'short', $TimeFormat = 'short', $locale = null)`
	- `formatDate($DateTime, $DateFormat = 'short', $locale = null)`
	- `formatTime($DateTime, $TimeFormat = 'short', $locale = null)`
- стандартный `NumberFormatter` (см. http://php.net/manual/en/class.numberformatter.php)
	- `formatNumber($number, $locale = null)`
	- `formatNumberWithFraction($number, $fraction = 2, $locale = null)`
	- `getThousandsSeparator($locale = null)`
	- `getDecimalPoint($locale = null)`
- спец.форматтеры 
	- `formatInterval($DateInterval)`
	- `formatCurrency($number, $currency = null, $round = true, $locale = null)`

## Форматы 

### DateFormat 

- `full` -- **Saturday, January 31, 2015** -- полная строка, с днём недели
- `long` -- **January 31, 2015** -- полная дата
- `medium` -- **Jan 31, 2015** -- дата с сокращением месяца, но месяц текстом
- `short` -- **1/31/15** -- год обычно сокращён (но не всегда), месяц числом 

см. http://userguide.icu-project.org/formatparse/datetime

### TimeFormat 

- `full` -- **2:30:00 PM GMT** -- полная строка с таймзоной
- `long` -- **2:30:00 PM GMT** -- обычно идентична `full` 
- `medium` -- **2:30:00 PM** -- полная строка без таймзоны
- `short` -- **2:30 PM** -- краткий формат, часы и минуты

см. http://userguide.icu-project.org/formatparse/datetime

### Number 

Числа всегда форматируются в `NumberFormatter::PATTERN_DECIMAL` -- то есть в итоговой строке присутствуют только цифры и разделители.

### Currency 

...

### Interval 

Специальный форматтер. Использует `translator` для перевода `DateInterval` в человекочитаемую форму. Игнорирует `$this->locale`.

## Проблемы

### Даты

В коде используется избыточное количество форматов даты и времени. Некоторые из этих форматов используются только один раз.

	'datetime' => "F d, Y H:i:s", January 01, 2100 10:10:10
	'date' => "m/d/Y", 01/10/2100
	'dateshort' => "m/d/y", 01/10/00
	'time' => "h:ia", 01:10am
	'timewithoutzero' => "g:i A", 1:10 AM
	'datelong' => "F j, Y", January 1, 2100
	'monthday' => "F j", January 1
	'timelong' => "g:i A", 1:10 AM
	'datetimelong' => "F j, Y g:i A",
	'weekdatetime' => "D m/d" Mon 01/10

Но! Некоторые из используемых форматов не реализуются с помощью стандартных `DateFormat` / `TimeFormat`.

Например, `monthday` -- отсутствует год; или `weekdatetime` -- присутствует день недели, но месяц в числовом виде.
Кроме этого, `IntlDateFormatter` при использовании `DateFormat` совместно с `TimeFormat` может по своему разумению добавлять в строку текст (например, **Saturday, January 31, 2015 at 2:30:00 PM GMT**, но **Saturday, January 31, 2015** и **2:30:00 PM GMT**)

Требуется:

- избавиться от лишних форматов вывода дат и времени в коде
	- решить, какие форматы не нужны
	- найти их на страницах
	- отдать страницы на редизайн
	- применить результат редизайна
- добавить к существующим форматам `DateFormat` вывод дня недели, лучше отдельным паттерном
	- разбить существующие вызовы форматтера с днём недели на два вызова, и склеивать форматированные строки

### Number

В коде используется множество вызовов `number_format` для форматирования чисел. Хуже того, в некоторых случаях, `number_format` используется для форматирования валют.  

Требуется:

- избавиться от всех `number_format`, заменить на вызовы форматтеров `formatNumber` / `formatNumberWithFraction` 
- в случаях, когда `number_format` используется для форматирования валют -- прекратить это делать!

### Currency 

Сейчас `formatCurrency` использует `NumberFormatter`, и форматирует валюты в текущей локали. Это неправильно, для форматирования валют необходимо использовать `CurrencyRepository::currencyFormat`.

Требуется:

- переписать `aw.locale.localizer` на использование `CurrencyRepository::currencyFormat`.

### Вывод чисел на клиенте 

Иногда JS коде ожидается, что строка с числом придёт в предсказуемом формате, и её можно будет безболезненно сконвертировать в число с помощью `parseFloat` / `parseInt`. Это в общем случае ошибочное поведение.

В случаях, когда на клиенте над числами производятся математические манипуляции, настройки форматирования игнорируются, применяется форматирование **en_US**. 

Требуется:

- когда требуется обработка чисел на клиенте, необходимо дополнительно к отформатированной строке передавать сырое значение
- перевести форматирование всех вычисленных чисел на `Intl.js` ( https://github.com/andyearnshaw/Intl.js )  

### Вывод дат на клиенте 

... показаний нет ...

(но на всякий случай)

Требуется:

- когда требуется обработка дат на клиенте, необходимо дополнительно к отформатированной строке передавать сырое значение
- перевести форматирование всех дат на `Intl.js` ( https://github.com/andyearnshaw/Intl.js )
	- а лучше вообще избавиться от форматирования дат на клиенте

### Вывод валют на клиенте 

Валюты в вычисляемых на клиенте значениях используются только в корзине. На данный момент в корзине используются только USD, и нет планов по приёму мультивалютных платежей.

Поэтому пока-что ничего специального делать не надо. Достаточно правильно форматировать числа на клиенте, и добавлять знак **$** к началу числа.

### Прочее 

В некоторых случаях, для вывода валюты проверяется страна проживания владельца аккаунта, и форматтер опускает символ **$** для жителей **USA**. 
Хотелось бы понять, насколько это поведение важно, и требуется ли его перенос в `aw.locale.localizer`.

В стандартной поставке порядка 500+ значений локалей. Искать нужную очень неудобно.
Хотелось бы понять, следует ли на это обращать внимание.

`JQ UI Datepicker` локализирует даты по-своему -- https://github.com/jquery/jquery-ui/tree/master/ui/i18n.
В данный момент в `Datepicker` передаётся `Language`, хотя по-хорошему надо передавать `Region`.
Но! `Datepicker` умеет не все 500+ локалей, поэтому нужно применить какую-то магию.
Например, передавать первую часть локали, и дополнительно выставлять формат даты на основе паттерна из `IntlDateFormatter`.
Но! Тут есть вторая засада -- паттерн из `IntlDateFormatter` очень не тривиально переводится в стандартный `DateTime::format`.
Хотелось бы понять, как с этим жить дальше.

И наконец. Если язык (например) **ru**, а локаль (например) **en_US**, то текстовые значения дней недели и месяцев будут выведены на **en**.
Возможно, так оно и задумано, но кажется, что есть в этом какой-то подвох. 

