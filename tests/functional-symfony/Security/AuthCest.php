<?php

namespace AwardWallet\Tests\FunctionalSymfony\Security;

use AwardWallet\MainBundle\Entity\Usr;
use AwardWallet\MainBundle\Globals\StringUtils;
use AwardWallet\MainBundle\Security\Reauthentication\Mobile\MobileReauthenticatorHandler;
use AwardWallet\Tests\FunctionalSymfony\_steps\Mobile\UserSteps;
use Codeception\Module\Aw;
use Google\Authenticator\GoogleAuthenticator;
use Symfony\Component\Security\Csrf\CsrfTokenManagerInterface;

/**
 * @group frontend-functional
 * @group login
 */
class AuthCest
{
    use \Awardwallet\Tests\Modules\AutoVerifyMocksTrait;
    use LoginTrait;

    private ?CsrfTokenManagerInterface $csrfTokenManager;

    public function _before(\TestSymfonyGuy $I)
    {
        session_write_close();
        unset($_SESSION);
        $this->csrfTokenManager = $I->grabService('security.csrf.token_manager');
    }

    public function _after(\TestSymfonyGuy $I)
    {
        $this->csrfTokenManager = null;
    }

    public function loginDesktop(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);

        $badUser = $user;
        $badUser['password'] = 'badpassword';
        $this->loginUser($badUser, $I);
        $I->seeResponseContainsJson([
            "success" => false,
            'badCredentials' => true,
            'message' => 'Invalid user name or password',
        ]);

        $this->loginUser($user, $I);
        $I->seeResponseContainsJson(["success" => true]);
        $I->assertEquals($user['userId'], $_SESSION['UserID']);
        $I->assertEquals($user['userId'], $_SESSION['UserFields']['UserID']);
        $I->assertEquals($user['login'], $_SESSION['UserFields']['Login']);
        $I->assertEquals($user['login'], $_SESSION['Login']);
        $I->assertEquals($user['email'], $_SESSION['Email']);
        $I->assertArrayNotHasKey('ManagerFields', $_SESSION);
        $I->assertEquals(ACCOUNT_LEVEL_FREE, $_SESSION['AccountLevel']);

        $I->amOnPage("/security/logout");
        $I->seeResponseContains("localStorage.removeItem");
        $I->amOnPage("/");
        $I->assertArrayNotHasKey('UserID', $_SESSION);
    }

    public function twoFactorLoginDesktop(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        /** @var GoogleAuthenticator $auth */
        [$secret, $_, $auth] = $I->createTwoFactorAuthCode($user['userId']);

        $this->loginUser($user, $I);
        $I->seeResponseContainsJson([
            "success" => false,
            "message" => "One-time code required",
            'otcRequired' => true,
            'badCredentials' => false,
            'otcInputLabel' => 'One-time code',
            'otcInputHint' => '(this is a 6-digit code generated by Google Authenticator or equivalent program)',
            'otcShowRecovery' => true,
        ]);

        $this->loginUser($user, $I, "123456");
        $I->seeResponseContainsJson([
            "success" => false,
            "message" => "The presented one-time code is invalid",
            'otcRequired' => true,
            'badCredentials' => false,
            'otcInputLabel' => 'One-time code',
            'otcInputHint' => '(this is a 6-digit code generated by Google Authenticator or equivalent program)',
            'otcShowRecovery' => true,
        ]);

        $this->loginUser($user, $I, $auth->getCode($secret));
        $I->seeResponseContainsJson([
            "success" => true,
        ]);
    }

    public function loginMobile(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        $steps = new UserSteps($I->grabScenarioFrom($I));
        $I->followRedirects(false);
        $steps->sendStatus();
        $steps->sendLoginForm($user["login"], $user["password"]);
        $I->seeResponseContainsJson(["success" => true]);
        $I->assertEquals($user['userId'], $_SESSION['UserID']);
        $I->assertEquals($user['userId'], $_SESSION['UserFields']['UserID']);
        $I->assertEquals($user['login'], $_SESSION['UserFields']['Login']);
        $I->assertEquals($user['login'], $_SESSION['Login']);
        $I->assertEquals($user['email'], $_SESSION['Email']);
        $I->assertArrayNotHasKey('ManagerFields', $_SESSION);
        $I->assertEquals(ACCOUNT_LEVEL_FREE, $_SESSION['AccountLevel']);

        $I->haveHttpHeader("Accept", "application/json");
        $I->amOnPage("/m/api/logout");
        $I->seeResponseContainsJson(["success" => true]);
        $I->haveHttpHeader("Accept", "text/html");
        $I->amOnPage("/");
        $I->assertArrayNotHasKey('UserID', $_SESSION);
    }

    public function loginBusinessNotAdmin(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        $I->amOnBusiness();
        $this->loginUser($user, $I);
        $I->seeResponseContainsJson(["success" => false]);
        $I->assertFalse(isset($_SESSION));
    }

    public function loginBusinessAdmin(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        $businessUserId = $I->createAwUser(null, null, ['AccountLevel' => ACCOUNT_LEVEL_BUSINESS]);
        $I->connectUserWithBusiness($user['userId'], $businessUserId, ACCESS_ADMIN);
        $business = $I->query("select * from Usr where UserID = :userId", ["userId" => $businessUserId])->fetch(\PDO::FETCH_ASSOC);

        $I->amOnBusiness();
        $this->loginUser($user, $I);
        $I->seeResponseContainsJson(["success" => true]);

        $I->assertTrue(isset($_SESSION));
        $I->assertEquals($businessUserId, $_SESSION['UserID']);
        $I->assertEquals($business['Login'], $_SESSION['UserFields']['Login']);
        $I->assertEquals($business['Login'], $_SESSION['Login']);
        $I->assertEquals($business['Email'], $_SESSION['Email']);
        $I->assertEquals($user['userId'], $_SESSION['ManagerFields']['UserID']);
        $I->assertEquals($user['login'], $_SESSION['ManagerFields']['Login']);
        $I->assertEquals(ACCOUNT_LEVEL_BUSINESS, $_SESSION['AccountLevel']);
    }

    public function registerDesktop(\TestSymfonyGuy $I)
    {
        $this->loadCSRF($I);
        $login = bin2hex(random_bytes(10));
        $I->haveHttpHeader("Content-Type", "application/json");
        $I->sendPOST("/user/register", '{"user":{"pass":"Somepass12","email":"' . $login . '@gmail.com","firstname":"Vladimir","lastname":"Silantyev"},"coupon":null,"recaptcha":"xxx"}');
        $I->seeResponseCodeIs(200);
        $I->seeResponseContainsJson(["success" => true]);
        $user = $I->query("select * from Usr where Login = ?", [$login])->fetch(\PDO::FETCH_ASSOC);
        $I->assertEquals($user['UserID'], $_SESSION['UserID']);
        $I->assertEquals($user['UserID'], $_SESSION['UserFields']['UserID']);
    }

    public function registerBusiness(\TestSymfonyGuy $I)
    {
        $I->amOnBusiness();
        $I->resetCookie("MOCKSESSID");
        $I->amOnPage("/");
        $I->saveCsrfToken();

        if (!preg_match('#name="user\[_token\]" value="([^"]+)"#', $I->grabResponse(), $matches)) {
            $I->fail("CSRF not found");
        }
        $csrf = $matches[1];
        $login = bin2hex(random_bytes(10));
        $content = [
            "user" => [
                "login" => $login,
                "pass" => [
                    "Password" => "Somepass12",
                    "ConfirmPassword" => "Somepass12",
                ],
                "company" => "Award" . $login,
                "firstname" => "Vladimir",
                "lastname" => "Silantyev",
                "email" => $login . '@gmail.com',
                "_token" => $csrf,
            ],
        ];
        $I->sendPOST("/user/register_business", $content);
        $I->seeResponseCodeIs(200);
        $I->seeResponseContainsJson(["redirectTo" => "/account/select-provider?new=1"]);
        $user = $I->query("select * from Usr where Login = ?", [$login])->fetch(\PDO::FETCH_ASSOC);
        $I->assertNotEquals($user['UserID'], $_SESSION['UserID']);
        $I->assertEquals($user['UserID'], $_SESSION['ManagerFields']['UserID']);
    }

    public function oldLogout(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        $this->loginUser($user, $I);
        $I->seeResponseContainsJson(["success" => true]);
        $I->assertEquals($user['userId'], $_SESSION['UserID']);
        $I->amOnPage("/security/logout");
        $I->seeResponseContains("localStorage.removeItem");
        $I->amOnPage("/");
        $I->assertArrayNotHasKey('UserID', $_SESSION);
    }

    public function switchUser(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        $I->amOnPage("/contact?_switch_user=" . $user['login']);
        $I->assertEquals($user['userId'], $_SESSION['UserID']);
        $I->amOnPage("/contact?_switch_user=_exit");
        $I->assertArrayNotHasKey('UserID', $_SESSION);
    }

    public function basicImpersonate(\TestSymfonyGuy $I)
    {
        $staff = $this->createUser($I, [], true);
        $this->loginUser($staff, $I, $staff['oneTimeCodeByApp']);

        $user = $this->createUser($I);
        $I->amOnPage("/manager/impersonate?UserID=" . $user['userId']);
        $I->seeResponseCodeIs(200);
        $I->seeInField("form[UserID]", $user['userId']);
        $I->fillField("form[Goto]", "/user/profile");
        $I->submitForm('form', []);
        $I->seeResponseCodeIs(200);
        $I->seeInDatabase('ImpersonateLog', ['UserID' => $staff['userId'], 'TargetUserID' => $user['userId'], 'IPAddress' => '127.0.0.1', 'UserAgent' => 'Symfony BrowserKit']);
        $I->seeCurrentUrlEquals("/user/profile");
        $I->see($user["login"]);
        $I->dontSee($staff["login"]);
        $I->assertEquals($user['userId'], $_SESSION['UserID']);

        $I->amOnPage("/manager/");
        $I->see("You are impersonated");

        $I->amOnPage("/security/logout");
        $I->followMetaRedirect();
        $I->seeCurrentUrlEquals("/manager/impersonate");
        $I->see($staff["login"]);
        $I->see("Impersonate");
        $I->assertEquals($staff['userId'], $_SESSION['UserID']);
    }

    public function impersonateAutoSubmit(\TestSymfonyGuy $I)
    {
        $staff = $this->createUser($I, [], true);
        $this->loginUser($staff, $I, $staff['oneTimeCodeByApp']);

        $user = $this->createUser($I);
        $I->amOnPage("/manager/impersonate?UserID=" . $user['userId'] . '&AutoSubmit=1&Goto=' . urlencode("/user/profile"));
        $I->seeCurrentUrlEquals("/user/profile");
        $I->see($user["login"]);
    }

    public function basicLogout(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        $this->loginUser($user, $I, null, true);
        $rememeberMeToken = $I->grabCookie("PwdHash");
        $I->assertNotEmpty($rememeberMeToken);
        $I->amOnPage("/security/logout");
        $I->followMetaRedirect();
        $I->seeCurrentUrlEquals("/");
        $I->assertArrayNotHasKey('UserID', $_SESSION);
        $I->dontSeeCookie("PwdHash");
        $I->setCookie("PwdHash", $rememeberMeToken);
        $I->amOnPage("/user/profile");
        $I->seeCurrentUrlEquals("/login?BackTo=%2Fuser%2Fprofile");
        $I->dontSee($user['login']);
    }

    public function impersonateAsBusiness(\TestSymfonyGuy $I)
    {
        $staff = $this->createUser($I, [], true);
        $this->loginUser($staff, $I, $staff['oneTimeCodeByApp']);

        $I->amOnPage("/manager/impersonate?UserID=" . Aw::BOOKER_ID . "&AutoSubmit=1&Goto=" . urlencode("/balance"));
        $ur = $I->grabService('doctrine')->getRepository(Usr::class);
        $business = $ur->find(Aw::BOOKER_ID);
        $admins = $ur->getBusinessAdmins($business);
        $admin = array_shift($admins);

        $I->seeInField("UserID", $admin->getUserid());
        $I->submitForm("form", []);
        $I->seeCurrentUrlEquals("/balance");
        $I->seeResponseCodeIs(200);
        $I->seeInSource("logo awardwallet");
        $I->assertEquals(Aw::BOOKER_ID, $_SESSION['UserID']);
        $I->assertEquals($admin->getUserid(), $_SESSION['ManagerFields']['UserID']);
    }

    public function managerAccess(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        $this->loginUser($user, $I);
        $I->amOnPage('/manager/');
        $I->dontSee('Welcome to manager');
    }

    public function switchToBusiness(\TestSymfonyGuy $I)
    {
        $ur = $I->grabService('doctrine')->getRepository(Usr::class);
        $business = $ur->find(Aw::BOOKER_ID);
        $admins = $ur->getBusinessAdmins($business);
        $admin = array_shift($admins);
        $I->amOnPage("/contact?_switch_user=" . urlencode($admin->getLogin()));
        $I->see($admin->getLastname());

        $I->amOnPage("/security/switch-site");
        $I->seeInField("UserID", $admin->getUserid());
        $I->submitForm("form", []);
        $I->seeCurrentUrlEquals("/awardBooking/queue");
        $I->assertEquals(Aw::BOOKER_ID, $_SESSION['UserID']);
        $I->assertEquals($admin->getUserid(), $_SESSION['ManagerFields']['UserID']);
    }

    public function switchToPersonal(\TestSymfonyGuy $I)
    {
        $ur = $I->grabService('doctrine')->getRepository(Usr::class);
        $business = $ur->find(Aw::BOOKER_ID);
        $admins = $ur->getBusinessAdmins($business);
        $admin = array_shift($admins);
        $I->amOnBusiness();
        $I->amOnPage("/contact?_switch_user=" . urlencode($admin->getLogin()));

        $I->amOnPage("/security/switch-site?Goto=" . urlencode("/user/profile"));
        $I->seeInField("UserID", $admin->getUserid());
        $I->submitForm("form", []);
        $I->seeCurrentUrlEquals("/user/profile");
        $I->assertEquals($admin->getUserid(), $_SESSION['UserID']);
        $I->assertArrayNotHasKey('ManagerFields', $_SESSION);
    }

    public function fullImpersonate(\TestSymfonyGuy $I)
    {
        $staff = $this->createUser($I, [], true);
        $otherStaff = $this->createUser($I, [], true);
        $I->amOnPage("/manager/impersonate?UserID=" . $otherStaff['userId'] . '&AutoSubmit=1&Goto=' . urlencode("/manager/impersonate") . "&Full=1&_switch_user=" . $staff['login']);
        $I->seeCurrentUrlEquals("/manager/impersonate");
        $I->seeResponseCodeIs(200);
        $I->see($otherStaff["login"]);
        $I->dontSee("You are impersonated");

        $I->amOnPage("/security/logout");
        $I->followMetaRedirect();
        $I->seeCurrentUrlEquals("/manager/impersonate");
        $I->see($staff["login"]);
        $I->see("Impersonate");
        $I->assertEquals($staff['userId'], $_SESSION['UserID']);
    }

    public function fullImpersonateBadIp(\TestSymfonyGuy $I)
    {
        $staff = $this->createUser($I, [], true);
        $otherStaff = $this->createUser($I, [], true);
        $I->setServerParameter("whiteListedIp", "");
        $I->amOnPage("/manager/impersonate?UserID=" . $otherStaff['userId'] . '&AutoSubmit=1&Goto=' . urlencode("/manager/") . "&Full=1&_switch_user=" . $staff['login']);
        $I->seeCurrentUrlEquals("/manager/");
        $I->seeResponseCodeIs(403);
        $I->see($otherStaff["login"]);
        $I->see("You are impersonated");
    }

    public function impersonateAndSwitch(\TestSymfonyGuy $I)
    {
        $staff = $this->createUser($I, [], true);
        $ur = $I->grabService('doctrine')->getRepository(Usr::class);
        $business = $ur->find(Aw::BOOKER_ID);
        $admins = $ur->getBusinessAdmins($business);
        $admin = array_shift($admins);

        $I->amOnPage("/manager/impersonate?UserID=" . $admin->getUserid() . '&AutoSubmit=1&Goto=' . urlencode("/user/profile") . "&_switch_user=" . $staff['login']);
        $I->seeCurrentUrlEquals("/user/profile");
        $I->seeResponseCodeIs(200);
        $I->see($admin->getLogin());

        $I->amOnPage("/security/switch-site");
        $I->seeInField("UserID", $admin->getUserid());
        $I->submitForm("form", []);

        $I->amOnPage("/security/switch-site?Goto=" . urlencode("/manager/"));
        $I->seeInField("UserID", $admin->getUserid());
        $I->submitForm("form", []);
        $I->seeCurrentUrlEquals("/manager/");
        $I->see("You are impersonated");

        $I->amOnPage("/security/logout");
        $I->followMetaRedirect();
        $I->seeCurrentUrlEquals("/manager/impersonate");
        $I->see($staff["login"]);
    }

    public function impersonateWithPlus(\TestSymfonyGuy $I)
    {
        $staff = $this->createUser($I, [], true);
        $user = $this->createUser($I, [], true);
        $accountId = $I->createAwAccount($user['userId'], 'testprovider', "nomatter");
        $I->amOnPage("/manager/impersonate?UserID=" . $user['userId'] . '&AutoSubmit=1&Goto=' . urlencode("/account/info/a" . $accountId) . "&_switch_user=" . $staff['login']);
        $I->seeCurrentUrlEquals("/account/info/a" . $accountId);
        $I->seeResponseCodeIs(200);
        $I->seeResponseContainsJson(["HideProperties" => true]);

        $I->amOnPage("/security/logout");
        $I->amOnPage("/manager/impersonate?UserID=" . $user['userId'] . '&AutoSubmit=1&Goto=' . urlencode("/account/info/a" . $accountId) . "&AwPlus=1&_switch_user=" . $staff['login']);
        $I->seeCurrentUrlEquals("/account/info/a" . $accountId);
        $I->seeResponseCodeIs(200);
        $I->seeResponseContainsJson(["HideProperties" => false]);
    }

    public function switchToNoBusiness(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        $I->amOnPage("/security/switch-site?_switch_user=" . $user['login']);
        $I->submitForm("form", []);
        $I->followMetaRedirect();
        $I->seeCurrentUrlEquals("/");
        $I->assertArrayNotHasKey("UserID", $_SESSION);
    }

    public function logoutOnPasswordChange(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        $I->amOnPage("/user/profile?_switch_user=" . $user['login']);
        $I->see($user['login']);
        $I->assertEquals($user['userId'], $_SESSION['UserID']);
        $I->executeQuery("update Usr set Pass = 'changed' where UserID = " . $user['userId']);
        $I->amOnPage("/user/profile");
        $I->dontSee($user['login']);
        $I->assertArrayNotHasKey("UserID", $_SESSION);
    }

    public function deleteUser(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I);
        $I->mockService(MobileReauthenticatorHandler::class, $I->stubMake(MobileReauthenticatorHandler::class, [
            'handle' => null,
            'reset' => null,
        ]));
        $I->amOnRoute('aw_user_delete', ['_switch_user' => $user['login']]);
        $I->seeResponseCodeIs(200);
        $I->seeInDatabase('Usr', ['Login' => $user['login']]);
        $I->haveHttpHeader('X-XSRF-TOKEN', $this->csrfTokenManager->getToken('')->getValue());
        $I->sendPost('/user/delete', [
            'reason' => 'test',
        ]);
        $I->seeResponseCodeIs(200);
        $I->dontSeeInDatabase('Usr', ['Login' => $user['login']]);
        $I->assertArrayNotHasKey("UserID", $_SESSION);
    }

    public function twoFactorAuth(\TestSymfonyGuy $I)
    {
        $user = $this->createUser($I, [
            'GoogleAuthSecret' => 'blah',
            'GoogleAuthRecoveryCode' => 'blah',
        ]);

        $this->loginUser($user, $I);
        $I->seeResponseContainsJson(["success" => false, "otcRequired" => true, "otcInputLabel" => "One-time code", "otcShowRecovery" => true, "otcInputHint" => "(this is a 6-digit code generated by Google Authenticator or equivalent program)"]);
    }

    public function userNotFound(\TestSymfonyGuy $I)
    {
        $I->dontSeeInDatabase('Usr', ['Login' => $login = StringUtils::getPseudoRandomString(16)]);
        $I->login($login, 'somepass');
        $a = 1;
        $I->seeResponseContainsJson([
            'success' => false,
            'message' => 'Invalid user name or password',
            'badCredentials' => true,
            'otcRequired' => false,
        ]);
    }
}
