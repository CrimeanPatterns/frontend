<?php

namespace AwardWallet\Tests\Unit\BusinessTransaction;

use AwardWallet\MainBundle\Entity\AbBookerInfo;
use AwardWallet\MainBundle\Entity\AbRequest;

/**
 * @group frontend-unit
 * @group billing
 */
class AbRequestClosedTest extends AbstractTest
{
    /** @var AbRequest */
    private $request;

    /** @var AbBookerInfo */
    private $bookInfo;

    public function _before()
    {
        parent::_before();

        $this->request = $this->em->getRepository(\AwardWallet\MainBundle\Entity\AbRequest::class)
            ->find($this->aw->createAbRequest());
        $this->request->setBooker($this->business);
        $this->em->flush();

        $this->bookInfo = $this->business->getBookerInfo();
    }

    public function _after()
    {
        $this->bookInfo =
        $this->request = null;

        parent::_after(); // TODO: Change the autogenerated stub
    }

    public function testAbRequestHasAlreadyBeenPaidException()
    {
        $this->expectException(\InvalidArgumentException::class);
        $this->expectExceptionMessageRegExp('#has already been paid#');
        $this->info->setTrialEndDate(null)->setBalance(100);
        $this->assertTrue($this->manager->bookingRequestComplete($this->request));
        $this->manager->bookingRequestComplete($this->request);
    }

    /**
     * trial for booking requests === discount 100.
     */
    public function testTrial()
    {
        $this->info->setBalance(0);
        $this->info->setTrialEndDate(new \DateTime("+1 day"))->setBalance(0);
        $this->assertTrue($this->info->isTrial());
        $this->assertTrue($this->manager->bookingRequestComplete($this->request));
        $this->assertNotEmpty($lastTransaction = $this->getLastTransaction());
        $this->assertEquals(0, $lastTransaction->getAmount());
        $this->assertEquals($this->info->getBalance(), $lastTransaction->getBalance());

        $this->assertEquals(0, $this->info->getBalance());
    }

    public function testBalanceIsZero()
    {
        $this->info->setTrialEndDate(null)->setBalance(0);
        $this->assertFalse($this->info->isTrial());
        $this->assertFalse($this->manager->bookingRequestComplete($this->request));
        $this->assertEquals(0, $this->info->getBalance());
    }

    public function testBalanceIsNotEnough()
    {
        $this->info->setBalance(3);
        $this->assertFalse($this->manager->bookingRequestComplete($this->request));
        $this->assertEmpty($lastTransaction = $this->getLastTransaction());
        $this->assertEquals(3, $this->info->getBalance());
    }

    public function testDiscountHundred()
    {
        $this->bookInfo->setDiscount(100);
        $this->info->setBalance(-20);
        $this->assertTrue($this->manager->bookingRequestComplete($this->request));
        $this->assertNotEmpty($lastTransaction = $this->getLastTransaction());
        $this->assertEquals(0, $lastTransaction->getAmount());
        $this->assertEquals(-20, $this->info->getBalance());
        $this->assertEquals($this->info->getBalance(), $lastTransaction->getBalance());
    }

    public function testDiscountTen()
    {
        $this->info->setBalance(30);
        $this->bookInfo->setDiscount(10);
        $this->assertFalse($this->info->isTrial());
        $this->assertTrue($this->manager->bookingRequestComplete($this->request));
        $this->assertNotEmpty($lastTransaction = $this->getLastTransaction());
        $this->assertEquals(18, $lastTransaction->getAmount());
        $this->assertEquals(12, $lastTransaction->getBalance());
        $this->assertEquals(12, $this->info->getBalance());
    }

    public function testDiscountZero()
    {
        $this->info->setBalance(30);
        $this->bookInfo->setDiscount(0);
        $this->assertFalse($this->info->isTrial());
        $this->assertTrue($this->manager->bookingRequestComplete($this->request));
        $this->assertNotEmpty($lastTransaction = $this->getLastTransaction());
        $this->assertEquals(20, $lastTransaction->getAmount());
        $this->assertEquals(10, $lastTransaction->getBalance());
        $this->assertEquals(10, $this->info->getBalance());
    }
}
