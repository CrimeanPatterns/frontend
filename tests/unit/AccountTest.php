<?php

namespace AwardWallet\Tests\Unit;

use AwardWallet\MainBundle\Entity\Account;
use AwardWallet\MainBundle\Entity\Providercoupon;
use AwardWallet\MainBundle\Entity\Rental;
use AwardWallet\MainBundle\Entity\Trip;
use AwardWallet\MainBundle\Entity\Tripsegment;
use AwardWallet\MainBundle\Entity\Useragent;
use AwardWallet\MainBundle\Entity\Usr;
use AwardWallet\MainBundle\Factory\AccountFactory;
use AwardWallet\MainBundle\Manager\AccountManager;
use Codeception\Module\Aw;
use Codeception\Module\CustomDb;

/**
 * @group frontend-unit
 */
class AccountTest extends BaseUserTest
{
    /**
     * @var \AwardWallet\MainBundle\Manager\AccountManager
     */
    protected $accountManager;

    public function _before()
    {
        parent::_before();
        $this->accountManager = $this->container->get(AccountManager::class);
    }

    public function _after()
    {
        $this->accountManager = null;
        parent::_after(); // TODO: Change the autogenerated stub
    }

    public function testCredentialsChanged()
    {
        $account = $this->container->get(AccountFactory::class)->create();
        $account->setPass('123');
        $this->assertEquals('123', $account->getPass());
        $this->assertTrue($account->credentialsChanged);
        $account->credentialsChanged = false;
        $account->setPass('123');
        $this->assertFalse($account->credentialsChanged);
        $account->setPass('123');
        $this->assertFalse($account->credentialsChanged);
        $account->setPass('123');
        $this->assertFalse($account->credentialsChanged);
        $account->setPass('12345');
        $this->assertTrue($account->credentialsChanged);
    }

    public function testSaveAccount()
    {
        $account = $this->getAccount('testlogin', 123);
        $this->em->persist($account);
        $this->em->flush();
        $this->assertNotEmpty($account->getAccountid());
        $this->assertEquals(123, $account->getPass());
    }

    public function testPasswordStorage()
    {
        $account = $this->getAccount('testlogin', 123);
        $this->assertEquals(SAVE_PASSWORD_DATABASE, $account->getSavepassword());
        $this->assertEquals(123, $account->getPass());
        $this->accountManager->setAccountStorage($account, $account->getSavepassword(), SAVE_PASSWORD_LOCALLY);
        $this->assertEquals(123, $account->getPass());
        $this->em->persist($account);
        $this->em->flush();
        $this->assertEquals(123, $account->getPass());
        $this->accountManager->setAccountStorage($account, $account->getSavepassword(), SAVE_PASSWORD_DATABASE);
        $this->assertEquals(123, $account->getPass());
        $this->em->flush();
        $this->assertEquals(123, $account->getPass());
    }

    public function testChangeModifyDate()
    {
        $account = $this->getAccount('testlogin', 123);
        $this->em->persist($account);
        $this->em->flush();
        $mdate = $account->getModifydate();
        $this->assertNotEmpty($mdate);
        // set login
        $account->setLogin(321);
        $this->em->flush();
        $this->assertNotEquals(spl_object_hash($mdate), spl_object_hash($account->getModifydate()));
        // set password
        $mdate = $account->getModifydate();
        $account->setPass('xxx');
        $this->em->flush();
        $this->assertNotEquals(spl_object_hash($mdate), spl_object_hash($account->getModifydate()));
        // set last change date
        $mdate = $account->getModifydate();
        $account->setLastchangedate(new \DateTime());
        $this->em->flush();
        $this->assertEquals(spl_object_hash($mdate), spl_object_hash($account->getModifydate()));
        // set last balance
        $account->setLastbalance(300);
        $this->em->flush();
        $this->assertEquals(spl_object_hash($mdate), spl_object_hash($account->getModifydate()));
    }

    public function testChangeOwner()
    {
        $uaRep = $this->em->getRepository(\AwardWallet\MainBundle\Entity\Useragent::class);
        $db = $this->getModule('CustomDb');
        // add account
        $account = $this->getAccount('testlogin', 123);
        $this->em->persist($account);
        $this->em->flush();
        $this->assertEquals($this->user, $account->getUserid());
        $this->assertEquals(null, $account->getUseragentid());
        // add coupon
        $coupon = $this->getCoupon();
        $this->em->persist($coupon);
        $this->em->flush();
        $this->assertEquals($this->user, $coupon->getUserid());
        $this->assertEquals(null, $coupon->getUseragentid());

        $newUser = $this->em->getRepository(\AwardWallet\MainBundle\Entity\Usr::class)->find($this->aw->createAwUser('new-owner-' . $this->aw->grabRandomString(5), Aw::DEFAULT_PASSWORD, []));
        $newBusinessUser = $this->em->getRepository(\AwardWallet\MainBundle\Entity\Usr::class)->find($this->aw->createAwUser('new-owner-bus-' . $this->aw->grabRandomString(5), Aw::DEFAULT_PASSWORD, [
            "AccountLevel" => ACCOUNT_LEVEL_BUSINESS,
        ]));
        $bua1 = $uaRep->find($this->aw->createConnection($newUser->getUserid(), $newBusinessUser->getUserid(), true, true, [
            "AccessLevel" => ACCESS_WRITE,
        ]));
        $bua2 = $uaRep->find($this->aw->createConnection($newBusinessUser->getUserid(), $newUser->getUserid(), true, true, [
            "AccessLevel" => ACCESS_ADMIN,
        ]));
        // connections
        $ua1 = $uaRep->find($this->aw->createConnection($newUser->getUserid(), $this->user->getUserid(), null, null, ['AccessLevel' => ACCESS_WRITE]));
        $ua2 = $uaRep->find($this->aw->createConnection($this->user->getUserid(), $newUser->getUserid(), null, null, ['AccessLevel' => ACCESS_WRITE]));
        $ua3 = $uaRep->find($this->aw->createFamilyMember($this->user->getUserid(), 'Billy', 'Villy'));

        // to connection personal
        $this->accountManager->setOwner($account, $newUser, $ua1);
        $this->assertEquals($newUser, $account->getUserid());
        $this->em->flush();
        $this->assertEquals(1, $account->getUseragents()->count());
        $this->assertEquals($this->user, $account->getUseragents()->first()->getAgentid());
        $this->assertEquals($newUser, $account->getUseragents()->first()->getClientid());

        $this->accountManager->setOwner($coupon, $newUser, $ua1);
        $this->assertEquals($newUser, $coupon->getUserid());
        $this->em->flush();
        $this->assertEquals(1, $coupon->getUseragents()->count());
        $this->assertEquals($this->user, $coupon->getUseragents()->first()->getAgentid());
        $this->assertEquals($newUser, $coupon->getUseragents()->first()->getClientid());

        $this->accountManager->setOwner($coupon, $newBusinessUser, $bua2);
        $this->assertEquals($newBusinessUser, $coupon->getUserid());
        $this->em->flush();
        $this->assertEquals(0, $coupon->getUseragents()->count());
        $db->dontSeeInDatabase("ProviderCouponShare", ["ProviderCouponID" => $coupon->getProvidercouponid()]);

        $this->accountManager->setOwner($account, $newUser, $ua1);
        $this->assertEquals($newUser, $ua1->getClientid());

        $this->accountManager->setOwner($account, $this->user, $ua3);
        $this->assertEquals($this->user, $account->getUserid());
        $this->assertEquals($ua3, $account->getUseragentid());

        // to connection business
        $this->accountManager->setOwner($account, $newBusinessUser, $bua2);
        $this->assertEquals($newBusinessUser, $account->getUserid());
        $this->em->flush();
        $this->assertEquals(0, $account->getUseragents()->count());
        $db->dontSeeInDatabase("AccountShare", ["AccountID" => $account->getAccountid()]);
    }

    public function testRelinkPlans()
    {
        // add account
        $account = $this->getAccount('testlogin', 123);
        $this->em->persist($account);
        $this->em->flush();
        $this->assertEquals($this->user, $account->getUserid());
        $this->assertEquals(null, $account->getUseragentid());
        // add coupon
        $coupon = $this->getCoupon();
        $this->em->persist($coupon);
        $this->em->flush();
        $this->assertEquals($this->user, $coupon->getUserid());
        $this->assertEquals(null, $coupon->getUseragentid());

        $uaRep = $this->em->getRepository(\AwardWallet\MainBundle\Entity\Useragent::class);
        /** @var CustomDb $db */
        $db = $this->getModule('CustomDb');
        $newUser = $this->em->getRepository(\AwardWallet\MainBundle\Entity\Usr::class)->find($this->aw->createAwUser('new-owner-' . $this->aw->grabRandomString(5), Aw::DEFAULT_PASSWORD, []));
        $newBusinessUser = $this->em->getRepository(\AwardWallet\MainBundle\Entity\Usr::class)->find($this->aw->createAwUser('new-owner-bus-' . $this->aw->grabRandomString(5), Aw::DEFAULT_PASSWORD, [
            "AccountLevel" => ACCOUNT_LEVEL_BUSINESS,
        ]));
        $bua1 = $uaRep->find($this->aw->createConnection($newUser->getUserid(), $newBusinessUser->getUserid(), true, true, [
            "AccessLevel" => ACCESS_WRITE,
        ]));
        $bua2 = $uaRep->find($this->aw->createConnection($newBusinessUser->getUserid(), $newUser->getUserid(), true, true, [
            "AccessLevel" => ACCESS_ADMIN,
        ]));
        // connections
        $ua1 = $uaRep->find($this->aw->createConnection($newUser->getUserid(), $this->user->getUserid(), null, null, ['AccessLevel' => ACCESS_WRITE]));
        $ua2 = $uaRep->find($this->aw->createConnection($this->user->getUserid(), $newUser->getUserid(), null, null, ['AccessLevel' => ACCESS_WRITE]));
        $ua3 = $uaRep->find($this->aw->createFamilyMember($this->user->getUserid(), 'Billy', 'Villy'));

        $itOwner = $this->em->getRepository(\AwardWallet\MainBundle\Entity\Usr::class)->find(Aw::SITEDMIN_ID);
        $it = $this->getTrip($account, $itOwner);
        $this->setOwner($account, $newUser, $ua1);
        $this->assertEquals($newUser, $ua1->getClientid());
        $db->seeInDatabase("Trip", [
            "UserID" => $newUser->getUserid(),
            "UserAgentID" => null,
            "AccountID" => $account->getAccountid(),
            "TripID" => $it->getId(),
        ]);

        $this->setOwner($account, $this->user);
        $db->seeInDatabase("Trip", [
            "UserID" => $this->user->getUserid(),
            "UserAgentID" => null,
            "AccountID" => $account->getAccountid(),
            "TripID" => $it->getId(),
        ]);

        $this->setOwner($account, $this->user, $ua3);
        $db->seeInDatabase("Trip", [
            "UserID" => $this->user->getUserid(),
            "UserAgentID" => $ua3->getUseragentid(),
            "AccountID" => $account->getAccountid(),
            "TripID" => $it->getId(),
        ]);
        $this->setOwner($account, $this->user);

        // Trip 2
        $it2 = $this->getTrip($account, $this->user, $ua3);
        $this->assertEquals(2, $db->grabCountFromDatabase("Trip", [
            "AccountID" => $account->getAccountid(),
        ]));

        // Trip 3
        $it3 = $this->getTrip($account, $newUser);
        $this->assertEquals(3, $db->grabCountFromDatabase("Trip", [
            "AccountID" => $account->getAccountid(),
        ]));

        // Rental
        $it4 = $this->getRental($account, $newUser);
        $this->assertEquals(1, $db->grabCountFromDatabase("Rental", [
            "AccountID" => $account->getAccountid(),
        ]));

        $this->setOwner($account, $this->user, $ua3);
        $this->assertEquals(3, $db->grabCountFromDatabase("Trip", [
            "AccountID" => $account->getAccountid(),
        ]));
        $this->assertEquals(1, $db->grabCountFromDatabase("Trip", [
            "AccountID" => $account->getAccountid(),
            "UserID" => $this->user->getUserid(),
            "UserAgentID" => $ua3->getUseragentid(),
        ]));
        $this->setOwner($account, $newBusinessUser);
        $this->assertEquals(3, $db->grabCountFromDatabase("Trip", [
            "AccountID" => $account->getAccountid(),
        ]));
        $this->assertEquals(3, $db->grabCountFromDatabase("Trip", [
            "AccountID" => $account->getAccountid(),
            "UserID" => $newBusinessUser->getUserid(),
            "UserAgentID" => null,
        ]));
        $this->assertEquals(1, $db->grabCountFromDatabase("Rental", [
            "AccountID" => $account->getAccountid(),
            "UserID" => $newBusinessUser->getUserid(),
            "UserAgentID" => null,
        ]));
    }

    private function getAccount($login, $pass)
    {
        $provider = $this->em->getRepository(\AwardWallet\MainBundle\Entity\Provider::class)->find(Aw::TEST_PROVIDER_ID);
        $user = $this->user;
        $account = $this->container->get(AccountFactory::class)->create();
        $account->localPasswordManager = $this->container->get('aw.manager.local_passwords_manager');
        $account->setProviderid($provider);
        $account->setUserid($user);
        $account->setSavepassword(SAVE_PASSWORD_DATABASE);
        $account->setLogin($login);
        $account->setPass($pass);

        return $account;
    }

    private function getCoupon()
    {
        $user = $this->user;
        $coupon = new Providercoupon();
        $coupon->setUserid($user);
        $coupon->setDescription('Test coupon');
        $coupon->setCreationdate(new \DateTime());
        $coupon->setProgramname('Program');
        $coupon->setKind(PROVIDER_KIND_AIRLINE);
        $coupon->setTypeid(Providercoupon::TYPE_COUPON);
        $coupon->setCardNumber(md5(time() . rand(0, 10000)));

        return $coupon;
    }

    private function getTrip(Account $account, Usr $user, ?Useragent $ua = null, $conf = 'ABC')
    {
        $it = new Trip();
        $segment = new Tripsegment();
        $segment->setDepname('depname');
        $segment->setDepartureDate(new \DateTime('tomorrow'));
        $segment->setArrname('arrname');
        $segment->setArrivalDate(new \DateTime('+2 days'));
        $it->addSegment($segment);
        $it->setUser($user);
        $it->setUserAgent($ua);
        $it->setAccount($account);
        $it->setConfirmationNumber($conf);
        $it->setDirection(true);
        $it->setCreatedate(new \DateTime());
        $this->em->persist($it);
        $this->em->flush();

        return $it;
    }

    private function getRental(Account $account, Usr $user, ?Useragent $ua = null, $conf = 'ABC')
    {
        $it = new Rental();
        $it->setUser($user);
        $it->setUserAgent($ua);
        $it->setAccount($account);
        $it->setConfirmationNumber($conf);
        $it->setCreatedate(new \DateTime());
        $it->setPickuplocation('AAA');
        $it->setPickupdatetime(new \DateTime());
        $it->setDropofflocation('BBB');
        $it->setDropoffdatetime(new \DateTime());
        $this->em->persist($it);
        $this->em->flush();

        return $it;
    }

    private function setOwner(Account $account, Usr $user, ?Useragent $ua = null)
    {
        $this->accountManager->setOwner($account, $user, $ua);
        $this->em->flush();
    }
}
