log_format awardwallet '$http_x_forwarded_for $host $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" "$sent_http_x_sessionid" "$sent_http_x_aw_userid" '
                    '"$sent_http_x_phptime" "$request_time" "$sent_http_x_requestid"';

map $sent_http_content_type $expires {
    default off;
    ~image/ 7d;
    ~font/ 7d;
    application/javascript 7d;
    text/css 7d;
}

map $http_origin $cors_header {
    default "";
    "~^https?://([^/]+\.)?awardwallet\.com(:[0-9]+)?$" "$http_origin";
}

map $http_x_forwarded_for $whiteListedIp {
    default "";
    "~^(52\.71\.169\.84|52\.5\.155\.96)$" "1";
}

gzip_types text/plain text/html text/xml application/javascript text/css application/json;
client_max_body_size 100M;
client_body_buffer_size 100M;
fastcgi_read_timeout 7200s;

server {
    large_client_header_buffers 4 32k;

    error_log  /dev/stderr;
    access_log /dev/stdout;
    access_log syslog:server=fluent:5140,facility=local7,tag=nginx,severity=info awardwallet;
    error_log syslog:server=fluent:5141,facility=local7,tag=nginx,severity=error;
    root /www/awardwallet/web;
    server_tokens off;
    add_header X-Frame-Options SAMEORIGIN;
    

    if ($host ~ beta\.) {
        rewrite ^(.*)$ https://awardwallet.com$1 permanent;
    }

    if ($http_user_agent ~* "MSIE [4-9]") {
            set $rwold '1';
    }

    if ($uri != '/old-browser.html') {
            set $rwold "${rwold}2";
    }

    if ($uri !~ '\.(ico|pdf|flv|jpg|jpeg|png|gif|js|css|swf|woff|ttf)') {
            set $rwold "${rwold}3";
    }

    if ($rwold = '123') {
            rewrite ^.*$ /old-browser.html last;
    }

    location /old-browser.html {
        add_header Cache-Control "max-age=0, must-revalidate, no-cache, no-store, post-check=0, pre-check=0, private";
        add_header Pragma "no-cache";                    
    }

    location /forum {
            rewrite ^.*$ / redirect;
    }

    set $test "";
    if ($http_x_forwarded_proto != "https") {
        set $test proto;
    }
    if ($uri !~ ^/account/redirect) {
        set $test "${test}_url";
    }
    if ($host !~ ^awrd\.co|award\.travel|awrd\.docker$) {
        set $test "${test}_host";
    }

    location ~ /m/api {
        try_files $uri @symfony;
    }

    location ~ /m/ {
        if ($http_x_forwarded_proto != "https") {
          rewrite ^(.*)$ https://$host$request_uri permanent;
        }
        try_files $uri $uri/ /m/index.html;
    }

    location / {
        #index @symfony;
        #index index.html index.php;
        #auth_basic "AwardWallet Beta";
        #auth_basic_user_file /etc/nginx/passwords;

        gzip on;
        expires $expires;

        try_files $uri $uri/ @symfony;
    }

    location ~ \.(ttf|ttc|otf|eot|woff|woff2|css)$ {
        add_header Access-Control-Allow-Origin $cors_header;
        gzip on;
        expires $expires;
    }

    location /api/awardwallet {
        if ($http_x_forwarded_proto != "https") {
          rewrite ^(.*)$ https://$host$1 permanent;
        }
        try_files $uri $uri/ @noauth;
    }

    location @noauth {
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $realpath_root/app.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        fastcgi_param SYMFONY_ENV prod;
        fastcgi_param SYMFONY_DEBUG 0;
    }

    location @symfony {
        #auth_basic "AwardWallet Beta";
        #auth_basic_user_file /etc/nginx/passwords;

        if ($host !~ (^|\.)(awardwallet\.com|awrd\.co|award\.travel)$) {
            rewrite ^(.*)$ https://awardwallet.com$request_uri;
        }
        if ($test = "proto_url_host") {
          rewrite ^(.*)$ https://$host$request_uri permanent;
        }

        gzip on;

        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_NAME /app.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root/app.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        fastcgi_param SYMFONY_ENV prod;
        fastcgi_param SYMFONY_DEBUG 0;
        fastcgi_param whiteListedIp $whiteListedIp;
        fastcgi_read_timeout 7200;

        internal;
    }

    # balancer, unauth
    location = /status.php {
        proxy_ignore_client_abort on;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        fastcgi_param SYMFONY_ENV prod;
        fastcgi_param SYMFONY_DEBUG 0;
        fastcgi_read_timeout 7200;
    }

    location ~ ^/(engine/\w+/extension\.js|api/?$) {
        try_files no_match @symfony;
    }

    #location ~ ^/r/([^/]+)/? {
    #      try_files no_match /rating/reviews.php?Provider=$1;
    #}

    location ~ \.php$ {
        #auth_basic "AwardWallet Beta";
        #auth_basic_user_file /etc/nginx/passwords;

        if ($host !~ (^|\.)(awardwallet.com|awrd\.co|award\.travel)$) {
            rewrite ^(.*)$ https://awardwallet.com$request_uri;
        }
        if ($test = "proto_url_host") {
          rewrite ^(.*)$ https://$host$request_uri permanent;
        }

        try_files $uri @symfony;

        gzip on;

        fastcgi_pass php:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        fastcgi_param SYMFONY_ENV prod;
        fastcgi_param SYMFONY_DEBUG 0;
        fastcgi_read_timeout 7200;
        fastcgi_param whiteListedIp $whiteListedIp;
    }

}
