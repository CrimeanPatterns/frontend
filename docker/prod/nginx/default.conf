log_format awardwallet '"$http_true_client_ip" $host $remote_user [$msec] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" "$sent_http_x_sessionid" "$sent_http_x_aw_userid" '
                    '"$sent_http_x_phptime" "$request_time" "$sent_http_x_requestid" "$sent_http_location"';

map $sent_http_content_type $expires {
    default off;
    ~image/ 365d;
    ~font/ 365d;
    application/javascript 365d;
    text/css 365d;
}

map $http_origin $cors_header {
    default "";
    "~^https?://([^/]+\.)?awardwallet\.com(:[0-9]+)?$" "$http_origin";
}

map $http_true_client_ip $whiteListedIp {
    default "";
    "~^(52\.71\.169\.84|52\.5\.155\.96)$" "1";
}

map $host $robotsFile {
    default default-unknown.txt;
    awardwallet.com personal.txt;
    business.awardwallet.com business.txt;
}

gzip_types text/plain text/html text/xml application/javascript text/css application/json;
client_max_body_size 100M;
client_body_buffer_size 100M;
fastcgi_read_timeout 180s;
fastcgi_buffer_size 256k;
fastcgi_buffers 4 256k;

# true-client-ip added in cloudfront edge function
# change to x-forwarded-for if you disable cloudfront
limit_req_zone $http_true_client_ip zone=one:10m rate=1r/s;

server {
    large_client_header_buffers 4 512k;

    error_log  /dev/stderr;
    access_log /dev/stdout awardwallet;
    access_log syslog:server=fluent:5140,facility=local7,tag=nginx,severity=info awardwallet;
    error_log syslog:server=fluent:5141,facility=local7,tag=nginx,severity=error;
    root /www/awardwallet/web;
    server_tokens off;
    add_header X-Content-Type-Options nosniff;

    if ($uri !~ '^/account/redirect') {
      set $xframeset "SAMEORIGIN";
    }
    add_header X-Frame-Options "${xframeset}";
    add_header X-Xss-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000" always;

    if ($host ~* ^www\.(.*)$) {
        return 301 https://awardwallet.com$request_uri;
    }

    if ($host ~ beta1\.) {
        return 301 https://awardwallet.com$1;
    }

    location /podcasts {
        return 302 /podcast;
    }

    set $rwold "";
    if ($http_user_agent ~* "MSIE [4-9]") {
            set $rwold '1';
    }
    if ($uri != '/old-browser.html') {
            set $rwold "${rwold}2";
    }
    if ($uri !~ '\.(ico|pdf|flv|jpg|jpeg|png|gif|js|css|swf|woff|ttf)') {
            set $rwold "${rwold}3";
    }
    if ($rwold = '123') {
            return 302 /old-browser.html;
    }

    location /old-browser.html {
        add_header Cache-Control "max-age=0, must-revalidate, no-cache, no-store, post-check=0, pre-check=0, private";
        add_header Pragma "no-cache";
    }

    location /forum {
            rewrite ^.*$ / redirect;
    }

    set $test "";
    if ($http_x_forwarded_proto != "https") {
        set $test proto;
    }
    if ($uri !~ ^(/account/redirect|/top100)) {
        set $test "${test}_url";
    }
    if ($host !~ ^awrd\.co|award\.travel|awrd\.docker$) {
        set $test "${test}_host";
    }

    location ~ /m/api {
        try_files /dev/null @symfony;
    }

    location ~ /m/ {
        include force-host-and-proto.conf;
        try_files $uri $uri/ /m/index.html;
    }

    location ~ ^(?<path>.+)--(?<theme>dark|light)@(?<ratio>(?:4|5|6)(\.\d+)?)x\.(?<ext>jpe?g|png|gif|webp)$ {
        try_files /$path--$theme@${ratio}x.$ext /$path--$theme@4x.$ext /$path--$theme@3.5x.$ext /$path--$theme@3x.$ext /$path--$theme@2x.$ext /$path--$theme@1.5x.$ext /$path--$theme@1x.$ext /$path.$ext;
    }

    location ~ ^(?<path>.+)--(?<theme>dark|light)@(?<ratio>3(\.\d+)?)x\.(?<ext>jpe?g|png|gif|webp)$ {
        try_files /$path--$theme@${ratio}x.$ext /$path--$theme@3x.$ext /$path--$theme@2x.$ext /$path--$theme@1.5x.$ext /$path--$theme@1x.$ext /$path.$ext;
    }

    location ~ ^(?<path>.+)--(?<theme>dark|light)@(?<ratio>2(\.\d+)?)x\.(?<ext>jpe?g|png|gif|webp)$ {
        try_files /$path--$theme@${ratio}x.$ext /$path--$theme@2x.$ext /$path--$theme@1.5x.$ext /$path--$theme@1x.$ext /$path.$ext;
    }

    location ~ ^(?<path>.+)--(?<theme>dark|light)@(?<ratio>1(\.\d+)?)x\.(?<ext>jpe?g|png|gif|webp)$ {
        try_files /$path--$theme@${ratio}x.$ext /$path--$theme@1x.$ext /$path.$ext;
    }

    #beta location ~* /[\w\-_]+\.(png|ico|jpg)$ {
    #beta   include force-host-and-proto.conf;
    #beta   gzip on;
    #beta   expires $expires;
    #beta   try_files $uri @symfony;
    #beta }

    # we do not need this route, routes were dumped to assets
    location /js/routing {
        return 403;
    }

    location / {
        #beta include auth.conf;
        include force-host-and-proto.conf;

        gzip on;
        expires $expires;

        try_files $uri @symfony;
    }

    location ~ \.(ttf|ttc|otf|eot|woff|woff2|css)$ {
        add_header Access-Control-Allow-Origin $cors_header;
        gzip on;
        expires $expires;
    }

    location /api/awardwallet {
        # no auth/limiter
        include force-host-and-proto.conf;
        include fastcgi-symfony.conf;
    }

    location /cardImage/proxy/ {
        # no auth/limiter
        include force-host-and-proto.conf;
        include fastcgi-symfony.conf;
    }

    location /api/reward-availability/search/result {
        # no auth/limiter
        include force-host-and-proto.conf;
        include fastcgi-symfony.conf;
    }

    location = /api/debugProxy/debugProxy.php {
        # no limiter
        include force-host-and-proto.conf;
        include fastcgi-symfony.conf;
    }

    # https://docs.aws.amazon.com/vpc/latest/userguide/AmazonDNS-concepts.html#vpc-dns-support
    # The Route 53 Resolver is located at 169.254.169.253 (IPv4), fd00:ec2::253 (IPv6),
    # and at the primary private IPV4 CIDR range provisioned to your VPC plus two.
    # For example, if you have a VPC with an IPv4 CIDR of 10.0.0.0/16 and an IPv6 CIDR of 2001:db8::/32,
    # you can reach the Route 53 Resolver at 169.254.169.253 (IPv4), fd00:ec2::253 (IPv6), or 10.0.0.2 (IPv4)
    # AW Main VPC (192.168.0.0) + 2 = 192.168.0.2
    resolver 192.168.0.2 valid=30s;
    set $centrifugo_endpoint http://centrifugo.loyalty.infra.awardwallet.com:8000;
    location ~ /connection/(websocket|http_stream|sse|emulation)$ {
      proxy_pass          $centrifugo_endpoint;
      proxy_http_version  1.1;
      proxy_set_header    Upgrade $http_upgrade;
      proxy_set_header    Connection "upgrade";
      proxy_set_header    Host $host;
      proxy_set_header    X-Real-IP $http_true_client_ip;
      proxy_set_header    X-Forwarded-For $http_true_client_ip;
      proxy_set_header    X-Forwarded-Host $server_name;
    }

    location @symfony {
        include limiter.conf;
        #beta include auth.conf;
        include force-host-and-proto.conf;
        include fastcgi-symfony.conf;

        if ($request_uri ~* "(.*(\?|\&|\%26)BackTo\=)|(.*(\?|\&|\%26)KeepDesktop\=)|(.*(\?|\&|\%26)mobile\=)|(.*(\?|\&|\%26)Abuse\=)|(.*(\?|\&|\%26)Code\=)") {
            add_header X-Robots-Tag "noindex, nofollow";
        }

        internal;
    }

    # balancer, unauth
    location = /status.php {
        proxy_ignore_client_abort on;
        include fastcgi-symfony.conf;
    }

    location ~ ^/(engine/\w+/extension\.js|api/?$) {
        try_files no_match @symfony;
    }

#    location ~ ^/r/([^/]+)/? {
#          try_files no_match /rating/reviews.php?Provider=$1;
#    }

    location ~ /(images|bundles|b|js|m|css)/.*\.php$ {
        return 403;
    }

    location ~ /(images|bundles|b|js|m|css)/.*/$ {
        return 403;
    }

    # double check, actually there should be no these files in containers
    location ~ ^/(admin|lib/admin)/ {
        return 403;
    }

    location ~ \.php$ {
        try_files /dev/null @symfony;
    }

    location = /robots.txt {
        try_files /assets/robots.txt/$robotsFile =404;
    }

    rewrite ^/m$ /m/ permanent;
}
