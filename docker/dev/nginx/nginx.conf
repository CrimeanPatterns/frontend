# X-Symfony-Env header should be preferred over SITE_STATE cookie
# SYMFONY_ENV will be replaced in docker/nginx-dev-entrypoint.sh
map "$cookie_SITE_STATE:$http_x_symfony_env:%SYMFONY_ENV%" $php_script_name {
    default "app_dev.php";
    ~^.*:(prod|staging|acceptance):.*$ "app.php";
    ~^(prod|staging|acceptance):.*:.*$ "app.php";
    ~^dev:.*:.*$ "app_dev.php";
    ~^.*:dev:.*$ "app_dev.php";
    ~^.*:.*:(prod|staging|acceptance)$ "app.php";
}

map "$cookie_SITE_STATE:$http_x_symfony_env:%SYMFONY_ENV%" $symfony_env {
    default "dev";
    ~^.*:(.+):.*$ $1;
    ~^(.+):.*:.*$ $1;
    ~^.*:.*:(.+)$ $1;
}

resolver 127.0.0.11 ipv6=off;

map "$arg_XDEBUG_SESSION_START:$cookie_XDEBUG_SESSION" $symfony_port {
    default "9000";
    ~^.*:(.+)$ "9001";
    ~^(.+):.*$ "9001";
}

map "$cookie_SITE_STATE:$http_x_symfony_env:%SYMFONY_ENV%" $symfony_debug {
    default "1";
    ~^.*:(prod|staging|acceptance):.*$ "0";
    ~^(prod|staging):.*:.*$ "0";
    ~^.*:dev:.*$ "1";
    ~^dev:.*:.*$ "1";
    ~^.*:.*:(prod|staging|acceptance)$ "0";
}

log_format awardwallet '$http_x_forwarded_for $host $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" "$sent_http_x_sessionid" "$sent_http_x_aw_userid" '
                    '"$sent_http_x_phptime" "$request_time" "$sent_http_x_requestid"';

map $host $robotsFile {
    default default-unknown.txt;
    awardwallet.docker personal.txt;
    business.awardwallet.docker business.txt;
}

server {
#    listen 443 ssl;
#    ssl_certificate /etc/ssl/awardwallet-selfsigned.crt;
#    ssl_certificate_key /etc/ssl/awardwallet-selfsigned.key;

    # fix issues with nginx within Docker container sending files from folder shared by Parallels from Mac to Debian 11
    # ex.: [alert] 31#31: *5 sendfile() failed (22: Invalid argument) while sending response to client
    sendfile off;
    large_client_header_buffers 4 32k;

    client_max_body_size 100M;
    client_body_buffer_size 100M;

    add_header X-Xss-Protection "1; mode=block" always;

    error_log  /dev/stderr notice;
    access_log /dev/stdout;
#    access_log syslog:server=fluent:5140,severity=info awardwallet;
#    error_log syslog:server=fluent:5141,severity=error;

#    access_log syslog:server=fluent:5140,facility=local7,tag=nginx,severity=info awardwallet;
#    error_log syslog:server=fluent:5141,facility=local7,tag=nginx,severity=error;

    root /www/awardwallet/web;

    # we do not need this route, routes were dumped to assets
    location /js/routing {
        return 403;
    }

    location ~ ^/(engine/\w+/extension\.js|api/?$) {
        try_files no_match @symfony;
    }

    location ~ \.(ttf|ttc|otf|eot|woff|woff2|css|js)$ {
        add_header Access-Control-Allow-Origin *;
        gzip on;
        add_header Cache-Control "max-age=0, must-revalidate, no-cache, no-store, post-check=0, pre-check=0, private";
        add_header Pragma "no-cache";
        try_files $uri @symfony;
    }

    if ($uri ~ ^/webPush/chrome/manifest.json) {
        set $symfony_env "dev";
        set $symfony_debug "1";
        set $php_script_name "app_dev.php";
    }

    if ($host ~ beta) {
      rewrite ^(.*)$ http://awardwallet.docker$1 permanent;
    }

    set $rwold "";
    if ($http_user_agent ~* "MSIE [4-9]") {
            set $rwold '1';
    }
    if ($uri != '/old-browser.html') {
            set $rwold "${rwold}2";
    }
    if ($uri !~ '\.(ico|pdf|flv|jpg|jpeg|png|gif|js|css|swf|woff|ttf)') {
            set $rwold "${rwold}3";
    }
    if ($rwold = '123') {
            rewrite ^.*$ /old-browser.html last;
    }

    location /old-browser.html {
        add_header Cache-Control "max-age=0, must-revalidate, no-cache, no-store, post-check=0, pre-check=0, private";
        add_header Pragma "no-cache";
    }

    location /forum {
            rewrite ^.*$ / redirect;
    }

    location ~ /m/.*\.(css|js)$ {
        try_files $uri =404;
        add_header Cache-Control "max-age=0, must-revalidate, no-cache, no-store, post-check=0, pre-check=0, private";
        add_header Pragma "no-cache";
    }

    location ~ /m/api {
        try_files /dev/null @symfony;
    }

    location ~ /m/ {
        try_files $uri $uri/ /m/index.html;
    }

    location ~ ^(?<path>.+)--(?<theme>dark|light)@(?<ratio>(?:4|5|6)(\.\d+)?)x\.(?<ext>jpe?g|png|gif|webp)$ {
        try_files /$path--$theme@${ratio}x.$ext /$path--$theme@4x.$ext /$path--$theme@3.5x.$ext /$path--$theme@3x.$ext /$path--$theme@2x.$ext /$path--$theme@1.5x.$ext /$path--$theme@1x.$ext /$path.$ext;
    }

    location ~ ^(?<path>.+)--(?<theme>dark|light)@(?<ratio>3(\.\d+)?)x\.(?<ext>jpe?g|png|gif|webp)$ {
        try_files /$path--$theme@${ratio}x.$ext /$path--$theme@3x.$ext /$path--$theme@2x.$ext /$path--$theme@1.5x.$ext /$path--$theme@1x.$ext /$path.$ext;
    }

    location ~ ^(?<path>.+)--(?<theme>dark|light)@(?<ratio>2(\.\d+)?)x\.(?<ext>jpe?g|png|gif|webp)$ {
        try_files /$path--$theme@${ratio}x.$ext /$path--$theme@2x.$ext /$path--$theme@1.5x.$ext /$path--$theme@1x.$ext /$path.$ext;
    }

    location ~ ^(?<path>.+)--(?<theme>dark|light)@(?<ratio>1(\.\d+)?)x\.(?<ext>jpe?g|png|gif|webp)$ {
        try_files /$path--$theme@${ratio}x.$ext /$path--$theme@1x.$ext /$path.$ext;
    }

    # https://tenzer.dk/nginx-with-dynamic-upstreams/
    resolver 127.0.0.11 valid=30s;
    set $centrifugo_endpoint http://centrifugo.loyalty.docker:8000;
    location ~ /connection/(websocket|http_stream|sse|emulation)$ {
      proxy_pass          $centrifugo_endpoint;
      proxy_http_version  1.1;
      proxy_set_header    Upgrade $http_upgrade;
      proxy_set_header    Connection "upgrade";
      proxy_set_header    Host $host;
      proxy_set_header    X-Real-IP $remote_addr;
      proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Host $server_name;
    }

    location / {
        try_files $uri @symfony;
    }

#    location ~ ^/r/([^/]+)/? {
#          try_files no_match /rating/reviews.php?Provider=$1;
#    }

    location /logs/ {
        autoindex on;
    }

    location @symfony {
        include fastcgi-symfony.conf;

        if ($request_uri ~* "(.*(\?|\&|\%26)BackTo\=)|(.*(\?|\&|\%26)KeepDesktop\=)|(.*(\?|\&|\%26)mobile\=)|(.*(\?|\&|\%26)Abuse\=)|(.*(\?|\&|\%26)Code\=)") {
            add_header X-Robots-Tag "noindex, nofollow";
        }
    }

    location ~ /(images|bundles|b|js|m|css)/.*\.php$ {
        return 403;
    }

    location ~\.php$ {
        try_files /dev/null @symfony;
    }

    location = /robots.txt {
        try_files /assets/robots.txt/$robotsFile =404;
    }

    rewrite ^/m$ /m/ permanent;
}
