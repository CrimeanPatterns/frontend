<?php

namespace AwardWallet\MainBundle\Form\Type;

use AwardWallet\MainBundle\Security\TwoFactorAuthentication\TwoFactorAuthenticationService;
use JMS\TranslationBundle\Model\Message;
use JMS\TranslationBundle\Translation\TranslationContainerInterface;
use Symfony\Component\Form\AbstractType;
use Symfony\Component\Form\Extension\Core\Type\HiddenType;
use Symfony\Component\Form\Extension\Core\Type\NumberType;
use Symfony\Component\Form\FormBuilderInterface;
use Symfony\Component\Form\FormEvent;
use Symfony\Component\Form\FormEvents;
use Symfony\Component\OptionsResolver\OptionsResolver;
use Symfony\Component\Security\Core\Authentication\Token\Storage\TokenStorageInterface;
use Symfony\Component\Validator\Constraints\NotBlank;
use Symfony\Component\Validator\Constraints\Type;

class TwoFactorAuthType extends AbstractType implements TranslationContainerInterface
{
    /**
     * @var TwoFactorAuthenticationService
     */
    private $twoAuthService;

    /**
     * @var TokenStorageInterface
     */
    private $tokenStorage;

    /**
     * @var string
     */
    private $host;

    public function __construct(
        TwoFactorAuthenticationService $twoAuthService,
        TokenStorageInterface $tokenStorage,
        $host
    ) {
        $this->twoAuthService = $twoAuthService;
        $this->tokenStorage = $tokenStorage;
        $this->host = $host;
    }

    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        $builder->add('qr', ImageType::class);
        $builder->add('code', NumberType::class, [
            'label' => 'two-fact.secretcode.label',
            'required' => true,
            'constraints' => [
                new NotBlank(),
                new Type(['type' => 'numeric']),
            ],
        ]);
        $builder->add('secret', HiddenType::class, [
            'constraints' => [
                new NotBlank(),
                new Type(['type' => 'string']),
            ],
        ]);

        $builder->addEventListener(FormEvents::PRE_SET_DATA, [$this, 'setQrCode']);
        $builder->addEventListener(FormEvents::PRE_SUBMIT, [$this, 'setQrCode']);
    }

    public function configureOptions(OptionsResolver $resolver)
    {
        $resolver->setDefaults([
            'error_bubbling' => false,
        ]);
    }

    public function getBlockPrefix()
    {
        return 'two_fact';
    }

    public function setQrCode(FormEvent $event)
    {
        $data = $event->getData();
        $secret = $data['secret'];
        $qrCode = $this->twoAuthService->generateOtpImage(
            $this->tokenStorage->getToken()->getUser(), $secret, $this->host, 'AwardWallet', 'png'
        );
        $data['qr'] = "data:image/png;base64," . base64_encode($qrCode);
        $event->setData($data);
    }

    /**
     * Returns an array of messages.
     *
     * @return array<Message>
     */
    public static function getTranslationMessages()
    {
        return [
            (new Message('two-fact.secretcode.label'))->setDesc('Code'),
            (new Message('two-fact.secretcode.help'))->setDesc('Please enter the code generated by Google Authenticator app'),
        ];
    }
}
