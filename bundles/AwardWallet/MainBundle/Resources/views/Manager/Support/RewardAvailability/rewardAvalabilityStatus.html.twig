{% set title = "RA Status" %}
{% set contentTitle = "" %}
{% set limitParseTime = 120 %}
{% use '@AwardWalletMain/FormTheme/oldFields.html.twig' %}
{% extends '@AwardWalletMain/Manager/layout.html.twig' %}
{% block content %}
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="/lib/scripts/scw.js"></script>
    <script src="/lib/3dParty/jquery/plugins/jquery.balloon.js"></script>
    <h1 style="font-size: medium">Reward Availability Status</h1>
    <div>
    <h1 style="font-size: small; display: inline">({{ startDate }}&nbsp;-&nbsp;{{ endDate }})</h1>
    <input id="off" type="checkbox">
    <label for="off">off autorefresh</label>
        {% if manageLog %}
    <strong style="float: inline-end;font-style: italic;">
        <b>kibana:&nbsp;</b>
        <a target="_blank" href="https://kibana.awardwallet.com/app/discover#/?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-7d,to:now))&_a=(columns:!(message,extra.provider,extra.partner),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:f7bcf3e0-1a67-11e9-8067-9bee5e3ddf43,key:message,negate:!t,params:(query:'Reward%20availability%20has%20parse%20notice'),type:phrase),query:(match_phrase:(message:'Reward%20availability%20has%20parse%20notice')))),index:f7bcf3e0-1a67-11e9-8067-9bee5e3ddf43,interval:auto,query:(language:kuery,query:'%22Reward%20availability%20has%22'),sort:!())">Parse Notice</a>
    </strong>
        {% endif %}
    </div>
    <style>
        div span.h{
            color:#999;
            cursor:pointer;
        }

        div span.val{
            color:#000;
            font-weight:bold;
        }

        i[class^="icon-"], i[class*=" icon-"] {
            display: inline-block;
            text-align: center;
            text-decoration: none;
            vertical-align: middle;
            background-image: url(/assets/awardwalletnewdesign/img/sprite.png?v=2);
            background-repeat: no-repeat;
        }
        .icon-blue-info {
            width: 9px;
            height: 9px;
            background-position: -686px -99px;
            float: left;
        }
        table.popupTitle td{
            padding: 4px;
            /*font-size: 100%;*/
            font-weight: bold;
            /*line-height: 2;*/
            text-align: right;
            background-color: #666;
            color: #fff
        }
        table {
            border-collapse: collapse;
            font-family: serif;
        }
        table td, table th {
            padding: 0;
            font-family: serif;
        }
        button.gray {
            padding: 0;
            padding-right: 2px;
            background: none;
            border: none;
            color: gray;
            cursor: pointer;
            font-size: x-small;
        }

        .inputDate {
            width: 80px;
        }

        .captchaCol {
            display: none;
        }

        .icon_show {
            background: url({{ asset('assets/awardwalletmain/images/icon-sprite.png') }}) -14px -15px no-repeat;
            height: 12px;
            width: 12px;
            display: inline-block;
            vertical-align: middle;
            margin-left: 3px;
            margin-right: 3px;
            float: right;
        }

        .icon_asc {
            background: url({{ asset('assets/awardwalletmain/images/icon-sprite.png') }}) -42px -12px no-repeat;
            height: 7px;
            width: 7px;
            display: inline-block;
            vertical-align: middle;
            margin-left: 3px;
            margin-right: 3px;
            float: right;
        }

        .icon_desc {
            background: url({{ asset('assets/awardwalletmain/images/icon-sprite.png') }}) -42px -19px no-repeat;
            width: 7px;
            height: 7px;
            display: inline-block;
            vertical-align: middle;
            margin-left: 3px;
            margin-right: 3px;
            float: right;
        }

        th, th * {
            font-weight: bold !important;
            text-align: center !important;
            vertical-align: bottom !important;
            white-space: nowrap;
            font-size: 13px;
            height: 22px;
        }

        td.ra, th.ra {
            background-color: white;
            border-bottom: #D0D0D0 1px solid;
            color: #4D4D4D;
            font-size: 13px;
            height: 22px;
            padding: 1px 4px 1px 4px;
            text-align: center;
            text-shadow: 0 1px 0 white;
        }

        td.ra-top, th.ra-top {
            background-color: white;
            border-top: #D0D0D0 1px solid;
            color: #4D4D4D;
            font-size: 13px;
            height: 22px;
            padding: 1px 4px 1px 4px;
            text-align: center;
            text-shadow: 0 1px 0 white;
        }
        table.cnt tbody {
            counter-reset: rowNumber;
        }

        table.cnt tbody tr.cnt {
            counter-increment: rowNumber;
        }

        table.cnt tbody tr.cnt td.cnt:first-child::before {
            content: counter(rowNumber);
            min-width: 1em;
        }
        table.ra {
            width: 100%;
        }

        table.ra th {
            background: ghostwhite
        }
        table.ra td {
            background: azure;
        }
        table.ra tr.alert td {
            background: seashell;
        }
        table.ra th>table td {
            background: ghostwhite
        }

        table.ra table.details td, table.ra table.details th {
            background: white;
        }
        table.details {
            width: auto;
            margin: auto;
        }

        table .bothBorder {
            border-left: #D0D0D0 1px solid;
            border-right: #D0D0D0 1px solid;
        }

        table .leftBorder {
            border-left: #D0D0D0 1px solid;
        }

        table .rightBorder {
            border-right: #D0D0D0 1px solid;
        }

        table .topBorder {
            border-top: #D0D0D0 1px solid;
        }

        table.stat td {
            width: 33%;
        }
        table.stat2 td {
            width: 25%;
        }
        table td.request {
            margin: 0;
            padding: 0;
        }
        table.request tr {
            margin: 0;
            padding: 0;
        }
        table.request td {
            margin: 0;
            padding: 0;
            width: 33%;
        }
        table.ra th.sticky {
            /*background: white;*/
            position: sticky;
            top: 28px; /* Don't forget this, required for the stickiness */
        }
        table.ra th {
            /*background: white;*/
            position: sticky;
            top: 0; /* Don't forget this, required for the stickiness */
        }
        table.details th {
            /*background: white;*/
            position: static;
            top: 0; /* Don't forget this, required for the stickiness */
        }
        table.details th.sticky {
            /*background: white;*/
            position: sticky;
            top: 77px; /* Don't forget this, required for the stickiness */
        }
    </style>
    <script>
        function filterUniqueRows(){
            $('table.details tr').filter(function() {
                var text = $(this.cells[1]).text();2
                return $(this).prev('tr').filter(function() {
                    return $(this.cells[1]).text() === text;
                }).length;
            }).remove();
        }
        function copy(e) {
            var text = e.parentElement.title;
            var input = document.createElement('input');
            document.body.appendChild(input);
            input.value = text;
            input.select();
            document.execCommand("copy");
            document.body.removeChild(input);
        }
        function showDetails(el, type) {
            var elem = $(el).find('div');
            var details = elem.closest('table').closest('tr').next('tr');
            var provCode;
            provCode = elem.closest('table').parent().prevAll('td:odd:last').attr('data-provider');
            if (typeof provCode === 'undefined')
                provCode = elem.closest('table').parent().prevAll('td:even:last').attr('data-provider');
            // console.log(provCode);
            var color1 = color2 = 'border-box';
            switch (type){
                case 3:
                    color1 = '#CEFBC9'
                    color2 = '#F1FEF0'
                    break;
                case 5:
                    color1 = 'blanchedalmond'
                    color2 = 'cornsilk'
                    break;
                case 6:
                    color1 = 'blanchedalmond'
                    color2 = 'cornsilk'
                    break;
                case 4:
                    color1 = '#FDFB9A'
                    color2 = '#FEFEE5'
                    break;
                case 2:
                    color1 = '#FBC9C9'
                    color2 = '#FEF5F5'
                    break;
            }

            if (!details.is(":visible") || elem.hasClass('icon_asc')) {
                details.toggle();
            }
            if (elem.hasClass('icon_desc')) {
                if ($(el).hasClass('ra')){
                    parDiv = $(el).parent();
                } else
                    parDiv = $(el).parent().closest('td.ra').parent();
                var ascDivs = parDiv.find('div.icon_asc');
                ascDivs.removeClass('icon_asc');
                ascDivs.addClass('icon_desc');
                if (parDiv.hasClass('alert'))
                    parDiv.find('td').css('background', 'seashell');
                else
                    parDiv.find('td').css('background', 'azure');
            }
            if (details.is(":visible")) {
                elem.removeClass('icon_desc');
                elem.addClass('icon_asc');
                markPink();
                elem.parent().css('background',color1);
                getDetails(provCode, type, color1, color2);
            } else {
                if (elem.parent().closest('table').closest('tr').hasClass('alert'))
                    elem.parent().css('background', 'seashell');
                else
                    elem.parent().css('background', 'azure');
                markPink();
                elem.removeClass('icon_asc');
                elem.addClass('icon_desc');
            }
            // filterUniqueRows();
        }
        function getDetails(prov, typeState, colorTh, colorTd) {
            var rowProv = $('#' + prov);
            if (rowProv.attr('data-state') === typeState && rowProv.find('td').text().length > 0)
                return;
            rowProv.find('td').html('');
            $.ajax(
                {
                    url: "{{ path('aw_manager_rewardAvailabilityStatus_getListError') }}",
                    type: "POST",
                    data: {
                        providerCode: prov.trim(),
                        typeState: typeState,
                        startDate: '{{ startDate }}',
                        endDate: '{{ endDate }}',
                        cluster: '{{ cluster }}',
                        type: '{{ type }}',
                        priority: {{ priority }}
                    },
                    async: true,
                    success: function (data) {
                        if (data) {
                            rowProv.attr('data-state',typeState);
                            rowProv.find('td').html(data);
                            rowProv.find('td').find('table th').css('background',colorTh);
                            rowProv.find('td').find('table td').css('background',colorTd);
                        } else {
                            rowProv.removeAttr('data-state');
                            rowProv.find('td').html('something went wrong');
                        }
                        $('#' + prov + ' > td > table > tbody > tr > td:nth-child(9)').each(function () {
                            var txt = $(this).text();
                            txt = txt.substr(0,txt.indexOf('/'));
                            if (txt > {{ limitParseTime }}) {
                                $(this).css('font-weight', 'bold');
                                $(this).prev().prev().prev().prev().find('a').css('font-weight', 'bold');
                            }
                        })
                    }
                }
            );
        }
        function markPink(){
            $('#contentBody > table.ra > tbody > tr > td:nth-child(8) > table > tbody > tr > td:nth-child(2)').each(function () {
                if ($(this).text() > {{ limitParseTime }}) {
                    $(this).css('background', 'pink');
                }
            })
            $('#contentBody > table.ra > tbody > tr > td:nth-child(11) > table > tbody > tr > td').each(function () {
                if ($(this).text() > 0) {
                    $(this).css('background', 'pink');
                }
            })
        }
        function checkPriority(e) {
            var arr = new Map([
                ['priority', e.value]
            ]);
            updateLocationWithParams(arr);
        }
        function updateLocationWithParams(arr) {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            for (let pair of arr) {
                urlParams.delete(pair[0]);
                if (typeof pair[1] !=='undefined')
                urlParams.append(pair[0],pair[1]);
            }
            if (urlParams.size > 0)
                document.location = '{{ path('aw_manager_rewardAvailabilityStatus') }}?'+urlParams;
            else
                document.location = '{{ path('aw_manager_rewardAvailabilityStatus') }}';
        }

        {% if manageLog %}
        function checkCluster(e) {
            let matches = e.value.match(/(.+?)(?:-(flight|hotel))?$/);
            var arr = new Map([
                ['cluster', matches[1]],
                ['type', matches[2]]
            ]);
            updateLocationWithParams(arr);
        }
        function showProviderProxyStats(el) {
            var elem = $(el).find('div');
            var details = elem.closest('tr').next('tr');
            var provCode;
            provCode = elem.parent().text();
            var color1 = 'border-box';
            // color1 = '#FBC9C9'
            // color2 = '#FEF5F5'

            if (!details.is(":visible") || elem.hasClass('icon_asc')) {
                details.toggle();
            }
            if (elem.hasClass('icon_desc')) {
                var ascDivs = $(el).parent().find('div.icon_asc');
                ascDivs.removeClass('icon_asc');
                ascDivs.addClass('icon_desc');
            }
            if (elem.parent().closest('td.ra').parent().hasClass('alert'))
                elem.parent().closest('td.ra').parent().find('td').css('background', 'seashell');
            else
                elem.parent().closest('td.ra').parent().find('td').css('background', 'azure');
            if (details.is(":visible")) {
                elem.removeClass('icon_desc');
                elem.addClass('icon_asc');
                elem.parent().css('background', color1);
                markPink();
                getProviderProxyDetails(provCode, color1);
            } else {
                markPink();
                elem.removeClass('icon_asc');
                elem.addClass('icon_desc');
            }
            // filterUniqueRows();
        }
        function getProviderProxyDetails(prov, color) {
            var rowProv = $('#' + prov);
            if (rowProv.attr('data-state') === 'proxy' && rowProv.find('td').text().length > 0)
                return;
            rowProv.find('td').html('');
            $.ajax(
                {
                    url: "{{ path('aw_manager_rewardAvailabilityStatus_getProviderProxyStats') }}",
                    type: "POST",
                    data: {
                        providerCode: prov.trim(),
                        startDate: '{{ startDate }}',
                        endDate: '{{ endDate }}',
                        cluster: '{{ cluster }}',
                        type: '{{ type }}'
                    },
                    async: true,
                    success: function (data) {
                        if (data) {
                            rowProv.attr('data-state','proxy');
                            rowProv.find('td').html(data);
                            rowProv.find('td').css('background',color);
                        } else {
                            rowProv.removeAttr('data-state');
                            rowProv.find('td').html('something went wrong');
                        }
                        $('#' + prov + ' > td > table > tbody > tr > td:nth-child(9)').each(function () {
                            var txt = $(this).text();
                            txt = txt.substr(0,txt.indexOf('/'));
                            if (txt > {{ limitParseTime }}) {
                                $(this).css('font-weight', 'bold');
                                $(this).prev().prev().prev().prev().find('a').css('font-weight', 'bold');
                            }
                        })
                    }
                }
            );
        }
        function loadProxyStats(){
            var divProxy = $('#proxyStats');
            divProxy.html('');
            $.ajax(
                {
                    url: "{{ path('aw_manager_rewardAvailabilityStatus_getProxyStats') }}",
                    type: "POST",
                    data: {
                        startDate: '{{ startDate }}',
                        endDate: '{{ endDate }}',
                        cluster: '{{ cluster }}',
                        type: '{{ type }}'
                    },
                    async: true,
                    success: function (data) {
                        if (data) {
                            divProxy.html(data);
                            divProxy.prev('button').remove();
                        } else {
                            rowProv.html('something went wrong');
                        }
                    }
                }
            );
        }
        {% endif %}
        function sortTable(table, col, ext)
        {
            othersRows = $(table).find('tr[id]').get();
            toSortRows = $(table).children().children('tr:not([id])').get();
            resultRows = [];
            $(toSortRows[0].cells).css('background','ghostwhite');
            if (col === 10) {
                $(toSortRows[0].cells[col]).find('td').css('background','ghostwhite');
                $(toSortRows[0].cells[col]).find('td:nth-child('+ext+')').css('background','aliceblue');
                $(toSortRows[0].cells[7]).find('td').css('background','ghostwhite');
                $(toSortRows[0].cells[11]).find('td').css('background','ghostwhite');
            } else if (col === 11) {
                $(toSortRows[0].cells[col]).find('td').css('background','ghostwhite');
                $(toSortRows[0].cells[col]).find('td:nth-child('+ext+')').css('background','aliceblue');
                $(toSortRows[0].cells[10]).find('td').css('background','ghostwhite');
                $(toSortRows[0].cells[7]).find('td').css('background','ghostwhite');
            } else if (col === 7) {
                $(toSortRows[0].cells[col]).find('td').css('background','ghostwhite');
                $(toSortRows[0].cells[col]).find('td:nth-child('+ext+')').css('background','aliceblue');
                $(toSortRows[0].cells[10]).find('td').css('background','ghostwhite');
                $(toSortRows[0].cells[11]).find('td').css('background','ghostwhite');
            } else {
                $(toSortRows[0].cells[col]).css('background','aliceblue');
                $(toSortRows[0].cells[7]).find('td').css('background','ghostwhite');
                $(toSortRows[0].cells[10]).find('td').css('background','ghostwhite');
                $(toSortRows[0].cells[11]).find('td').css('background','ghostwhite');
            }
                // $(toSortRows[0].cells).css('text-decoration','none');
            // $(toSortRows[0].cells[col]).css('text-decoration','underline ');
            resultRows.push(toSortRows[0]);
            table.tBodies[0].append(...resultRows);
            resultRows = [];
            toSortRows = toSortRows.slice(1);

            // col=0;
            let sortedRows = Array.from(toSortRows)
                .sort((rowA, rowB) => {
                    if(col === 10 || col === 7 || col === 11) {
                    // if(col === 7 || col === 5) {
                        dataA=$(rowA.cells[col]).find('td:nth-child('+ext+')').get(0);
                        dataB=$(rowB.cells[col]).find('td:nth-child('+ext+')').get(0);
                    // } else if (col === 5){
                    //     dataA=$(rowA.cells[col]).find('td:nth-child('+ext+')').get(0);
                    //     dataB=$(rowB.cells[col]).find('td:nth-child('+ext+')').get(0);
                    } else {
                        dataA=rowA.cells[col];
                        dataB=rowB.cells[col];
                    }
                    if (Number(dataA.innerHTML.match(/(.+?)(?:\/|<|$)/)[1])>0)
                    {
                        valA = Number(dataA.innerHTML.match(/(.+?)(?:\/|<|$)/)[1]);
                        valB = Number(dataB.innerHTML.match(/(.+?)(?:\/|<|$)/)[1]);
                    } else {
                        valA = dataA.innerHTML;
                        valB = dataB.innerHTML;
                    }
                    if (col === 10 || col === 7 || col === 11)
                    // if (col === 7 || col === 5)
                        cond = (valA < valB);
                    else
                        cond = (valA > valB);
                return (cond ? 1 : -1);
            });

            sortedRows.forEach(function (row){
                resultRows.push(row);
                let provCol = row.cells[1].innerHTML.match(/^([\w_]+)\s*(?:<|$)/);
                resultRows.push($(othersRows).filter('#'+provCol[1]).get(0));
            });

            table.tBodies[1].append(...resultRows);
        }

        $(document).ready(function () {
            $('#contentBody > table.ra tr:nth-child(1) > th:nth-child(14)').click();
            $('.bl').balloon({html: true, position:"right",
                css: {
                    border: 'solid 2px #5baec0',
                    fontSize: '100%',
                    fontWeight: 'bold',
                    backgroundColor: '#666',
                    color: '#fff'
                }});

            // reload page every 5 min
            let timerId = setTimeout(function () {
                window.location.reload();
            }, 1000 * 60 * 5);
            $('#off').on('click', function () {
                if ($(this).is(':checked')){
                    clearTimeout(timerId);
                } else {
                    timerId = setTimeout(function () {
                        window.location.reload();
                    }, 1000 * 60 * 5);
                }
            });
            markPink();
            $('table.ra > tbody > tr:first > th:nth-child(2), th:nth-child(3),th:nth-child(5),th:nth-child(6),th:nth-child(13), th:nth-child(14)').css('width','3%');
            $('table.ra > tbody > tr:first > th:nth-child(8)').css('width','12%');
            $('table.ra > tbody > tr:first > th:nth-child(11)').css('width','15%');
            $('table.ra > tbody > tr:first > th:nth-child(12)').css('width','15%');
            $('table.ra > tbody > tr:first > th:nth-child(4)').css('width','12%');
            $('table.ra > tbody > tr:first > th:nth-child(10)').css('width','10%');
            $('table.ra > tbody > tr:first > th:nth-child(7)').css('width','10%');

        });
        function getHours(){
            let hours = $('#hours').val();
            if (Number(hours)>0){
                {% if manageLog %}
                document.location='{{ path('aw_manager_rewardAvailabilityStatus') }}?hours='+hours+'&cluster={{ cluster }}&type={{ type }}&priority={{ priority }}';
                {% else %}
                document.location='{{ path('aw_manager_rewardAvailabilityStatus') }}?hours='+hours+'&priority={{ priority }}';
                {% endif %}
                return true;
            }
            alert('incorrect value hours');
            return false;
        }
    </script>
    {% if manageLog %}
        <select onchange="checkCluster(this);">
            {% for n,c in clustersList %}
                {% if c=='ra-awardwallet' %}
                    <option value="{{ c }}-flight" {% if cluster==c and type=='flight' %}selected="selected"{% endif %}>{{ n }}-flight</option>
                    <option value="{{ c }}-hotel" {% if cluster==c and type=='hotel' %}selected="selected"{% endif %}>{{ n }}-hotel</option>
                {% else %}
                    <option value="{{ c }}" {% if cluster==c %}selected="selected"{% endif %}>{{ n }}</option>
                {% endif %}
            {% endfor %}
        </select>
        <br>
    {% endif %}
    <label for="selPrior">priority</label>
    <select onchange="checkPriority(this);" id="selPrior">
        {% for c in [0,1,2,3,4,5,6,7,8,9] %}
            <option value="{{ c }}" {% if priority==c %}selected="selected"{% endif %}>{{ c }}</option>
        {% endfor %}
    </select>
    <br>
    <br>
    <div style="float: left;"><label for="hours">last&nbsp;</label><input id="hours" type="text" style="width: 45px;" value="{% if period %}4{% else %}{{ hours }}{% endif %}">&nbsp;hours</div>
    <button onclick="getHours(); return false;"
            style="float: left; margin-left: 5px;">show</button>
    <div style="float: left; margin-left: 130px;" id="period">
        <form>
            {% if manageLog %}
            <input type="hidden" value="{{ cluster }}" name="cluster" id="cluster">
            {% endif %}
            <input type="hidden" value="{{ priority }}" name="priority" id="priority">
            <input type="hidden" value="{{ type }}" name="type" id="type">

            <div style="float: left">
                {% set widget = 'single_text' %}
                {% set attr = { } %}
                {% set name = 'datePick1' %}
                {% if not period %}
                    {% set value = '' %}
                {% else %}
                    {% set value = startDate[:10] %}
                {% endif %}
                {% set id = 'datePickId1' %}
                {% set full_name = 'startDate' %}
                {% set required = false %}
                {% set pattern = '' %}
                {{ block('date_widget') }}
            </div>
            <input name="startTime" style="float: left; padding: 4px; width: 35px; height: 10px;" value="{{ startTime }}" required pattern="[0-9]{2}:[0-9]{2}">&nbsp-

            <div style="float: left">
                {% set widget = 'single_text' %}
                {% set attr = { } %}
                {% set name = 'datePick2' %}
                {% if not period %}
                    {% set value = '' %}
                {% else %}
                    {% set value = endDate[:10] %}
                {% endif %}
                {% set id = 'datePickId2' %}
                {% set full_name = 'endDate' %}
                {% set required = false %}
                {% set pattern = '' %}
                {{ block('date_widget') }}
            </div>
            <input name="endTime" style="float: left; padding: 4px; width: 35px; height: 10px;" value="{{ endTime }}" required pattern="[0-9]{2}:[0-9]{2}">
            <button type="submit">update</button>
        </form>
    </div>
    <div style="float: right;">
        <span class='h' title='anti-captcha.com balance'>anti-captcha.com:</span>
        <span class='val'>$&nbsp;{{ balance.antigate }}</span>
        {% if balance.rucaptcha is defined %}&nbsp;
            <span class='h' title='ruCaptcha.com balance'>ruCaptcha.com:</span>
            <span class='val'>&#8381;&nbsp;{{ balance.rucaptcha }}</span>
        {% endif %}&nbsp;&nbsp;&nbsp;
    </div>
    <br>
    <br>
    <table class="ra cnt" style="border-collapse: collapse;">
        <tr class="cnt">
            <th class="topBorder bothBorder ra sticky" style="cursor: pointer; text-decoration: underline;">#</th>
            <th class="topBorder rightBorder ra sticky" onclick="sortTable($(this).parent().parent().parent().get(0),1,1);" style="cursor: pointer; text-decoration: underline;">code</th>
            <th class="topBorder rightBorder ra sticky" onclick="sortTable($(this).parent().parent().parent().get(0),2,1);" style="cursor: pointer; text-decoration: underline;">total<br>&nbsp;/&nbsp;<br>total errors</th>
            <th class="topBorder rightBorder ra sticky">
                <table style="text-align: center; width: 100%;">
                    <tr>
                        <th colspan="3" class="ra">requests</th>
                    </tr>
                    <tr>
                        <td style="width: 33%;"><br>success</td>
                        <td style="width: 34%;"><br>errors</td>
                        <td style="width: 33%;"><br>unknown</td>
                    </tr>
                </table>
            </th>
            <th class="topBorder rightBorder ra sticky">last</th>
            <th class="topBorder rightBorder ra sticky" title="parsing succes rate. (states: 1,9) / (all requests)"  onclick="sortTable($(this).parent().parent().parent().get(0),5,1);" style="cursor: pointer; text-decoration: underline;">success %</th>
            <th class="topBorder rightBorder ra sticky">
                <table style="text-align: center; width: 100%;">
                    <tr>
                        <th colspan="3" class="ra">queue time (s)</th>
                    </tr>
                    <tr>
                        <td><br>min</td>
                        <td><br>max</td>
                        <td><br>avg</td>
                    </tr>
                </table>
            </th>
            <th class="topBorder rightBorder ra sticky">
                <table style="text-align: center; width: 100%;">
                    <tr>
                        <th colspan="3" class="ra">parsing time (s)
                            <div class="icon_show" title="show/hide captcha time" onclick="$('.captchaCol').toggle();"></div>
                        </th>
                    </tr>
                    <tr>
                        <td><br>min</td>
                        <td onclick="sortTable($(this).closest('table').parent().parent().parent().parent().get(0),7,2);" style="cursor: pointer;text-decoration: underline;"><br>max</td>
                        <td><br>avg</td>
                    </tr>
                </table>
            </th>
            <th class="topBorder rightBorder ra sticky captchaCol">
                <table style="text-align: center; width: 100%;">
                    <tr>
                        <th colspan="3" class="ra">captcha time (s)</th>
                    </tr>
                    <tr>
                        <td><br>min</td>
                        <td><br>max</td>
                        <td><br>avg</td>
                    </tr>
                </table>
            </th>
            <th class="topBorder rightBorder ra sticky">
                <table style="text-align: center; width: 100%;">
                    <tr>
                        <th colspan="3" class="ra">full time (s)</th>
                    </tr>
                    <tr>
                        <td><br>min</td>
                        <td><br>max</td>
                        <td><br>avg</td>
                    </tr>
                </table>
            </th>
            <th class="topBorder rightBorder ra sticky">
                <table style="text-align: center; width: 100%;">
                    <tr>
                        <th colspan="4" class="ra">over 90 sec</th>
                    </tr>
                    <tr>
                        <td title="requests (count) with parsing time over 90 sec" style="width: 25%;">parse<br>(cnt)</td>
                        <td title="parsing time over 90 sec (%)" onclick="sortTable($(this).closest('table').parent().parent().parent().parent().get(0),10,2);" style="cursor: pointer;text-decoration: underline; width: 25%;">parse<br>(%)</td>
                        <td title="requests (count) with full processing time over 90 sec" style="width: 25%;">full<br>(cnt)</td>
                        <td title="full processing time over 90 sec (%)" onclick="sortTable($(this).closest('table').parent().parent().parent().parent().get(0),10,4);" style="cursor: pointer;text-decoration: underline;width: 25%;">full<br>(%)</td>
                    </tr>
                </table>
            </th>
            <th class="topBorder rightBorder ra sticky">
                <table style="text-align: center; width: 100%;">
                    <tr>
                        <th colspan="4" class="ra">over 120 sec</th>
                    </tr>
                    <tr>
                        <td title="requests (count) with parsing time over 120 sec" style="width: 25%">parse<br>(cnt)</td>
                        <td title="parsing time over 120 sec (%)" onclick="sortTable($(this).closest('table').parent().parent().parent().parent().get(0),11,2);" style="cursor: pointer;text-decoration: underline; width: 25%">parse<br>(%)</td>
                        <td title="requests (count) with full time over 120 sec" style="width: 25%">full<br>(cnt)</td>
                        <td title="full processing time over 120 sec (%)" onclick="sortTable($(this).closest('table').parent().parent().parent().parent().get(0),11,4);" style="cursor: pointer;text-decoration: underline;width: 25%">full<br>(%)</td>
                    </tr>
                </table>
            </th>
            <th class="topBorder rightBorder ra sticky" onclick="sortTable($(this).parent().parent().parent().get(0),12,1);" style="cursor: pointer; text-decoration: underline;">priority</th>
            <th class="topBorder bothBorder ra sticky" title="{{ titleTotal }}" onclick="sortTable($(this).parent().parent().parent().get(0),13,1);" style="cursor: pointer; text-decoration: underline;">total<br>Success</th>
            {#            <th class="topBorder rightBorder ra sticky">show errors</th>#}
        </tr>
        <tbody>
        {% for prov,row in data %}
            <tr class="cnt {% if not(row.success is defined) or ( ((row.success)/row.requests*100)<75) %}alert{% endif %}" style="color: #3acde4;">
                <td class="cnt topBorder bothBorder ra"></td>
                <td data-provider="{{ prov }}" class="topBorder rightBorder ra" style="{% if row.alarm is defined %}color: red;{% endif %}"
                    {% if manageLog %}onclick="showProviderProxyStats(this)" style="cursor: pointer;"{% endif %}
                    title="{% if providers[prov] is defined %}{{ providers[prov]|e }}{% endif %}">{{ prov }}
                    {% if manageLog %}
                        <div class='icon_desc'></div>
                    {% endif %}
                </td>
                <td class="topBorder rightBorder ra">
                    {{ row.requests }}&nbsp;/&nbsp;{% if row.errors is defined %}{{ row.errors }}{% else %}0{% endif %}
                </td>
                <td class="topBorder rightBorder ra request">
                    <table class='request' style="text-align: center; width: 100%; height: 100%;border-collapse: collapse;">
                        <tr>
                            <td class="rightBorder" {% if row.success is defined %}onclick="showDetails(this, 3)" style="cursor: pointer;" {% endif %}>
                                {% if row.success is defined %}{{ row.success }}&nbsp;&nbsp;
                                    <i class="icon-blue-info bl"
                                       title=
                                       "<table class='popupTitle'><tr><td>State</td><td>Count</td></tr>
                                        {% for key,value in row.successState %}<tr><td>{{ key}}</td><td>{{ value}}</td></tr>{% endfor %}
                                        </table>">
                                    </i>
                                <div class='icon_desc'></div>{% endif %}
                            </td>
                            <td class="rightBorder" {% if row.known is defined %}onclick="showDetails(this, 4)" style="cursor: pointer;" {% endif %}>
                                {% if row.known is defined %}{{ row.known }}&nbsp;&nbsp;
                                    <i class="icon-blue-info bl"
                                       title="
                                       <table class='popupTitle'><tr><td>State</td><td>Count</td></tr>
                                        {% for key,value in row.knownState %}<tr><td>{{ key}}</td><td>{{ value}}</td></tr>{% endfor %}
                                       </table>">
                                    </i>
                                <div class='icon_desc'>{% endif %}</td>
                            <td {% if row.unknown is defined %}onclick="showDetails(this, 2)" style="cursor: pointer;" {% endif %}>
                                {% if row.unknown is defined %}{{ row.unknown }}&nbsp;&nbsp;
                                    <i class="icon-blue-info bl"
                                       title="
                                       <table class='popupTitle'><tr><td>State</td><td>Count</td></tr>
                                        {% for key,value in row.unknownState %}<tr><td>{{ key}}</td><td>{{ value}}</td></tr>{% endfor %}
                                       </table>">
                                    </i>
                                <div class='icon_desc'>{% endif %}</td>
                        </tr>
                    </table>
                </td>
                <td class="topBorder rightBorder ra">{{ row.lastTime }}</td>
                <td class="topBorder rightBorder ra">{% if row.success is defined %}{{ ((row.success)/row.requests*100)|round(2, 'ceil') }}{% else %}0{% endif %}</td>
                <td class="topBorder rightBorder ra">
                    <table class='stat' style="text-align: center; width: 100%;">
                        <tr>
                            <td>{{ row.queueTime.min }}</td>
                            <td>{{ row.queueTime.max }}</td>
                            <td>{{ row.queueTime.avg }}</td>
                        </tr>
                    </table>
                </td>
                <td class="topBorder rightBorder ra">
                    <table class='stat' style="text-align: center; width: 100%;">
                        <tr>
                            <td>{{ row.parsingTime.min }}</td>
                            <td>{{ row.parsingTime.max }}</td>
                            <td>{{ row.parsingTime.avg }}</td>
                        </tr>
                    </table>
                </td>
                <td class="topBorder rightBorder ra captchaCol">
                    <table class='stat' style="text-align: center; width: 100%;">
                        <tr>
                            <td>{{ row.captchaTime.min }}</td>
                            <td>{{ row.captchaTime.max }}</td>
                            <td>{{ row.captchaTime.avg }}</td>
                        </tr>
                    </table>
                </td>
                <td class="topBorder rightBorder ra">
                    <table class='stat' style="text-align: center; width: 100%;">
                        <tr>
                            <td>{{ row.fullProcessingTime.min }}</td>
                            <td>{{ row.fullProcessingTime.max }}</td>
                            <td>{{ row.fullProcessingTime.avg }}</td>
                        </tr>
                    </table>
                </td>
                <td class="topBorder rightBorder ra" {% if row.fullProcessingTimeGT90.sum > 0 %}title="show last details (max 200)" onclick="showDetails(this, 5)" style="cursor: pointer;"{% endif%}>
                    <table class='stat2' style="text-align: center; width: 100%;">
                        <tr>
                            <td title="requests (count) with parsing time over 90 sec">{{ row.parsingTimeGT90.sum }}</td>
                            <td title="parsing time over 90 sec (%)">{% if row.parsingTimeGT90.all>0 %}{{ (row.parsingTimeGT90.sum/row.parsingTimeGT90.all*100)|round(2, 'ceil') }}{% else %}0{% endif %}</td>
                            <td title="requests (count) with full processing time over 90 sec">{{ row.fullProcessingTimeGT90.sum }}</td>
                            <td  title="full processing time over 90 sec (%)">{% if row.fullProcessingTimeGT90.all>0 %}{{ (row.fullProcessingTimeGT90.sum/row.fullProcessingTimeGT90.all*100)|round(2, 'ceil') }}{% else %}0{% endif %}
                                {% if row.fullProcessingTimeGT90.sum > 0 %}<div class='icon_desc' style="float: right">{% endif %}</td>

                        </tr>
                    </table>
                </td>
                <td class="topBorder rightBorder ra" {% if row.fullProcessingTimeGT120.sum > 0 %}title="show last details (max 200)" onclick="showDetails(this, 6)" style="cursor: pointer;"{% endif%}>
                    <table class='stat2' style="text-align: center; width: 100%;">
                        <tr>
                            <td title="requests (count) with parsing time over 120 sec">{{ row.parsingTimeGT120.sum }}</td>
                            <td title="parsing time over 120 sec (%)">{% if row.parsingTimeGT120.all>0 %}{{ (row.parsingTimeGT120.sum/row.parsingTimeGT120.all*100)|round(2, 'ceil') }}{% else %}0{% endif %}</td>
                            <td title="requests (count) with full processing time over 120 sec">{{ row.fullProcessingTimeGT120.sum }}</td>
                            <td  title="full processing time over 120 sec (%)">{% if row.fullProcessingTimeGT120.all>0 %}{{ (row.fullProcessingTimeGT120.sum/row.fullProcessingTimeGT120.all*100)|round(2, 'ceil') }}{% else %}0{% endif %}
                                {% if row.fullProcessingTimeGT120.sum > 0 %}<div class='icon_desc' style="float: right">{% endif %}</td>

                        </tr>
                    </table>
                </td>
                <td class="topBorder rightBorder ra">{{ row.priority }}</td>
                <td class="topBorder bothBorder ra">{% if row.totalSuccess is defined %}{{ ((row.totalSuccess)/row.requests*100)|round(2, 'ceil') }}{% else %}0{% endif %}</td>
            </tr>
            <tr id='{{ prov }}' style="display:none">
                <td colspan="13" class="topBorder bothBorder"></td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <br>
    <br>
    {% if manageLog %}
        <button onclick="loadProxyStats();" style="padding:0;background:none;border:none;color:maroon;cursor:pointer;">‚ùí&nbsp;load proxy stats</button>
        <div id="proxyStats"></div>
    {% endif %}
    <br>
{% endblock %}