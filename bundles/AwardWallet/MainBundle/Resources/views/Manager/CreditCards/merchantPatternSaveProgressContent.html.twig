<style>
    .pattern-changed {
        color: orange;
        font-weight: bold;
    }

    .pattern-removed {
        color: red;
        font-weight: bold;
    }

    .pattern-added {
        color: green;
        font-weight: bold;
    }
    /* Style the button that is used to open and close the collapsible content */
    .collapsible {
      background-color: #f8f8f8;
      color: #444;
      cursor: pointer;
      width: 13%;
      border: none;
      text-align: left;
      outline: none;
    }

    /* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
    .active, .collapsible:hover {
      background-color: #ccc;
    }

    /* Style the collapsible content. Note: hidden by default */
    .content {
      padding: 0 18px;
      display: none;
      overflow: hidden;
      background-color: #f1f1f1;
    }

    .collapsible:after {
      content: '\02795'; /* Unicode character for 'plus' sign (+) */
      font-size: 13px;
      color: white;
      float: right;
      margin-left: 5px;
    }

    .active:after {
      content: '\2796'; /* Unicode character for 'minus' sign (-) */
    }

    .stop-btn-link{
      border:none;
      outline:none;
      background:none;
      cursor:pointer;
      color:#FF0000;
      padding:0;
      text-decoration:none;
      font-family:inherit;
      font-size:inherit;
    }
    .stop-btn-link:active{
      color:#FF0000;
    }
</style>
<script>
    function collapsibleEventListener() {
        this.classList.toggle('active');
        var content = this.nextElementSibling;
        if (content.style.display === 'block') {
          content.style.display = 'none';
        } else {
          content.style.display = 'block';
        }
    }

    require(['centrifuge', 'routing'], function(Centrifuge) {
        const client = new Centrifuge({{ centrifuge_config | json_encode | raw }});
        const channels = {{ channels | json_encode | raw }};
        client.on('connect', function () {
            console.log('centrifuge connected');
            const onMessageFactory = (channel) => (message) => {
                const data = message.data;
                console.log("mylog", data);
                const channelState = {...channels[channel], ...data};
                channels[channel] = channelState;
                const channelIdSelector = `channel-${channel.replace('$', '-amp-')}`;
                let progressBox = $(`#${channelIdSelector}`);

                if (!progressBox.length) {
                    const isCancelled = channelState.state === 'cancelled';
                    $('#progress-list').append(`
                        <div id="${channelIdSelector}">
                            <span style="font-weight: bold" class="progress-header">
                                (pattern: ${channelState.merchant_name},
                                started: ${channelState.start_date},
                                user: ${channelState.user})
                                <button type="submit" class="stop-btn-link" style="${isCancelled ? "display: none" : ""}">‚èπ</button>:
                            </span>
                            <span class="progress-state">
                                ${channelState.state_info}
                            </span>
                            <br/>
                            <div style="display: none" class="progress-diff">
                                <button type='button' class='collapsible'>Show changes</button>
                                <div class='content'></div>
                            </div>
                        </div>
                    `);
                    progressBox = $(`#${channelIdSelector}`);
                    setTimeout(() => {
                        progressBox.find('.progress-diff button').get(0).addEventListener('click', collapsibleEventListener);
                        progressBox.find('.stop-btn-link').get(0).addEventListener('click', () =>
                            $.ajax({
                                url: Routing.generate("aw_manager_merchant_pattern_cancel_task"),
                                type: 'POST',
                                data: {
                                    channel: channel,
                                },
                                success: function (data) {
                                    console.log("cancel response:", data);
                                }
                            })
                        )
                    });
                }

                const showDiff = () => setTimeout(() => {
                    if (!channelState.diff.length) {
                        return;
                    }

                    const diffBox = progressBox.find(`.progress-diff`);
                    diffBox.show();
                    const diffContent = diffBox.find('.content');
                    diffContent.html(channelState.diff.join("\n"));
                });

                if (data.type === 'log') {
                    const isFinished = ['finished', 'cancelled'].includes(channelState.state);
                    const progressState = progressBox.find('.progress-state');
                    const needFullState = !['queued', 'squashed'].includes(channelState.state);

                    if (needFullState) {
                        progressState.html(`
                            ${channelState.state_info},
                            last updated: ${channelState.last_updated},
                            ${isFinished ? "took" : "elapsed"}: ${channelState.elapsed_mins} min(s),
                            processed: ${channelState.processed_count},
                            updated: ${channelState.updated_count},
                            speed: ${channelState.speed}
                        `);
                    } else {
                        progressState.html(channelState.state_info);
                    }
                }

                if (channelState.diff.length) {
                    showDiff();
                }

                return channelState.state !== 'finished';
            };

            Object.entries(channels).forEach(([channelId, channelData]) => {
                const onMessage = onMessageFactory(channelData.channel);
                const needSub = onMessage({data: {type: "initial"}});

                if (!needSub) {
                    return;
                }

                let historyLockResolver = null;
                const historyLock = new Promise((resolve) => {
                    historyLockResolver = resolve;
                });
                const subscription = client.subscribe(channelData.channel, function (message) {
                    historyLock.then(() => onMessage(message));
                });
                subscription.history().then(function (message) {
                    console.log('history messages received', message);
                    $.each(message.data.reverse(), function (index, value) {
                        onMessage(value);
                    });
                    console.log('history messages processed', message);
                    historyLockResolver();
                }, function (err) {
                    console.log('history call failed', err);
                });
            });
        });
        client.connect();
    });

</script>
<div id="progress-list"></div>
<div id="response-written"></div>
