{% block capitalcards_oauth_row %}
	{% apply spaceless %}
		<div class="main-separator row-{{ name|lower }}"></div>
		<div class="row-inside row-{{ name|lower }}">
			<div class="main-form-title">
				{{ 'oauth.info'|trans({
					'%programName%': form.vars.program_name
				})|desc('We have a direct API integration with %programName%,
						powered by %programName%, which is the most secure and efficient way to pull account information.
						So we are not actually pulling your account information from %programName% website.'
				) }}
			</div>

			{# rewards #}
			<div id="rewards-oauth-complete" style="display: none;">
				<div class="success-message-row">
					<i class="icon-green-check-b"></i>
					<p>{{ 'capital-one-miles-access-desc'|trans|desc('Capital One Miles (Provides access to your Capital One Miles reward balance)') }}
					<br/>{{ 'oauth.status'|trans|desc('Account Status') }}: <strong>{{ 'oauth.status.authenticated'|trans|desc('Authenticated') }}</strong></p>
				</div>
				{# <a data-prefix="rewards" class="btn-blue revoke-oauth-button">{{ 'capital-one-revoke-miles-access'|trans|desc('Revoke Capital One miles access for AwardWallet') }}</a> #}
				<a data-prefix="rewards" class="btn-blue revoke-oauth-button">Revoke Capital One miles access for AwardWallet</a>
			</div>
			<div id="rewards-oauth-none" style="display: none;">
				<div class="error-message-row">
					<i class="icon-red-error-b"></i>
					<p>{{ 'capital-one-miles-access-desc'|trans|desc('Capital One Miles (Provides access to your Capital One Miles reward balance)') }}
					<br/>{{ 'oauth.status'|trans|desc('Account Status') }}: <strong>{{ 'oauth.status.not-authenticated'|trans|desc('Not authenticated') }}</strong></p>
				</div>
				<a data-prefix="rewards" class="btn-{{ form.vars.program_code }} open-oauth-popup-button add-oauth-button">{{ 'button.oauth.authenticate'|trans({'%programName%': form.vars.program_name})|desc('Connect with %programName%') }}</a>
			</div>

			{# transactions #}
			<div id="tx-oauth-complete" style="display: none;">
				<div class="success-message-row">
					<i class="icon-green-check-b"></i>
					<p>{{ 'capital-one-tx-access-desc'|trans|desc('Capital One Transactions (Provides access to your Capital One credit card transactions)') }}
					<br/>{{ 'oauth.status'|trans|desc('Account Status') }}: <strong>{{ 'oauth.status.authenticated'|trans|desc('Authenticated') }}</strong></p>
				</div>
				{# <a data-prefix="tx" class="btn-blue revoke-oauth-button">{{ 'capital-one-revoke-tx-access'|trans|desc('Revoke Capital One transactions access for AwardWallet') }}</a> #}
				<a data-prefix="tx" class="btn-blue revoke-oauth-button">Revoke Capital One transactions access for AwardWallet</a>
			</div>
			<div id="tx-oauth-none" style="display: none;">
				<div class="error-message-row">
					<i class="icon-red-error-b"></i>
					<p>{{ 'capital-one-tx-access-desc'|trans|desc('Capital One Transactions (Provides access to your Capital One credit card transactions)') }}
					<br/>{{ 'oauth.status'|trans|desc('Account Status') }}: <strong>{{ 'oauth.status.not-authenticated'|trans|desc('Not authenticated') }}</strong></p>
				</div>
				<a data-prefix="tx" class="btn-{{ form.vars.program_code }} open-oauth-popup-button add-oauth-button">{{ 'button.oauth.authenticate'|trans({'%programName%': form.vars.program_name})|desc('Connect with %programName%') }}</a>
			</div>

		</div>
		{% if form.vars.autologin_notice %}
		<div class="main-separator row-{{ name|lower }}"></div>
		<div class="row-inside row-{{ name|lower }}">
			<div class="main-form-title">
				{{ 'oauth.info.2'|trans({
					'%programName%': form.vars.program_name
				})|desc('Providing account credentials is optional for %programName%
				 		as we have API integration with them and only needed for the auto-login feature.') }}
				</div>
		</div>
		{% endif %}

		<div id="ieWarning" style="display: none;" title="TLS 1.2 protocol needed" >
			<div>
				<p>
					In order to connect with {{ form.vars.program_name }} using this outdated version of Internet Explorer please
					make sure you enable TLS 1.2 protocol in the settings of Internet Explorer:
				</p>
				<br />
				<p>
					<img src="/assets/awardwalletnewdesign/img/capital-one-ie.png" alt="IE_warning">
				</p>
			</div>
		</div>

		<script>
			require(['jquery-boot', 'lib/dialog', 'common/alerts', 'vendor/jquery-scrollintoview/jquery.scrollintoview'], function($, dialog){

				/**
				 * @param prefix - 'rewards' or 'tx'
				 * @param filled - bool - true|false|null - null = hidden row
				 */
				function updateInputsState(prefix, filled) {
					$('#' + prefix + '-oauth-none' ).toggle(filled === null ? false : !filled);
					$('#' + prefix + '-oauth-complete' ).toggle(filled === null ? false : filled);
				}

				function updateState()
				{
					console.log('state', state);
					updateInputsState('rewards', state.rewards !== null);
					// show tx block only if rewards were filled in, or we already have tx access
					updateInputsState('tx', (state.rewards || state.tx) ? state.tx !== null : null);
				}

				function setState(prefix, value)
				{
					state[prefix] = value;
					updateState();
					$('#{{ id }}').val(JSON.stringify(state));
				}

				var state = JSON.parse($('#{{ id }}').val());
				updateState();

				var auth_popup;

				$('.open-oauth-popup-button').on('click', function(e){
					e.preventDefault();
					const popupLocation = '{{ path('aw_auth_' ~ form.vars.program_code ~ '_authorize', {'requestId': form.vars.request_id, 'platform': 'desktop'}) }}?prefix=' + $(this).data('prefix');

					var h = 650;
					var w = 450;
					var y = window.top.outerHeight / 2 + window.top.screenY - ( h / 2);
					var x = window.top.outerWidth / 2 + window.top.screenX - ( w / 2);

					console.log('openinig popup', popupLocation);
					auth_popup = window.open(popupLocation, 'auth_{{ form.vars.program_code }}', 'toolbar=no, location=0, directories=no, status=no, menubar=no, scrollbars=yes, resizable=0, copyhistory=no, width='+w+', height='+h+', top='+y+', left='+x);
				});

				$('.revoke-oauth-button').on('click', function(e){
					e.preventDefault();
					setState($(this).data('prefix'), null);
					$('#account_login2').trigger('change');
				});

				$('#account-form').on('submit', null, null, function(event){
					if($('#account_{{ name }}').attr('required') && $.trim($('#account_{{ name }}').val()) == ''){
						event.preventDefault();
						var button = $('#oauth-none');
						(button).scrollintoview();
						button.effect('shake');
						return false;
					}
				});

				var popup = $('#ieWarning');

				{% if not app.request.cookies.has('hideOauthPopup') %}

				var d = dialog.createNamed('ieWarning', popup, {
					autoOpen: false,
					modal: true,
					minWidth: 480,
					buttons: [
						{
							text: "{{ 'popup.never_show'|trans|desc('Never show me this popup') }}",
							"class": "silver-link",
							click: function() {
								document.cookie = "hideOauthPopup=1;path=/";
								d.close();
							}
						},
						{

							text: Translator.trans("button.ok"),
							"class": "btn-blue",
							click: function() {
								d.close();
							}
						}
					]
				});

				// IE10+ is ok, show popup if lower
				if(navigator.appName.indexOf("Internet Explorer")!=-1){

					if(navigator.appVersion.indexOf("MSIE 1")==-1){
						d.open();
					}
				}

				{% endif %}

				window.addEventListener("message", function (event) {
					var origin = event.origin || event.originalEvent.origin;
					// For Chrome, the origin property is in the event.originalEvent object.
					console.log(event);
					if (origin !== "{{ url_scheme }}://{{ host }}") {
						return;
					}

					if (typeof (event.data) !== 'object' || event.data.messageType !== 'oauth') {
						return;
					}

					console.log('processing oauth message');

					if (event.data.error) {
						console.log('oauth error: ' + event.data.error);
						auth_popup.close();
						jAlert({{ 'error.auth.failure'|trans|json_encode|raw }});
						return;
					}

					$('#account_login2').trigger('change');
					setState(event.data.prefix, event.data.authInfo);
					auth_popup.close();

					if (state.rewards && !state.tx) {
						var d = dialog.prompt(
							{{ 'capital-one-analyze-tx-text'|trans|desc('Would you like us to analyze your credit card transactions so that you can optimize your spending for maximum earnings?')|json_encode|raw }},
							{{ 'capital-one-analyze-tx-title'|trans|desc('Credit Card Transactions')|json_encode|raw }},
							function() {
							},
							function() {
								$('#tx-oauth-none .open-oauth-popup-button').trigger('click');
							}
						);
					}

					if (state.rewards && state.tx) {
						console.log('auth complete, save');
						setTimeout(function() {
							$('#submit-button').click();
						}, 500);
					}
				}, false);
			});


		</script>
		<input type="hidden" {{ block('widget_attributes') }} value="{{ value }}"/>
	{% endapply %}
{% endblock %}
