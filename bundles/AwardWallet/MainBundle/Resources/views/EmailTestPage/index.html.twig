{% extends "@AwardWalletMain/Page/apiEmailParsing.html.twig" %}
{% import '@AwardWalletMain/Faq/macro.html.twig' as macro %}
{% import '@AwardWalletMain/TwigMacros/common.html.twig' as menuMacros %}

{% block title %}Email parser API test page (v2){% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="../../assets/awardwalletmain/css/highlightjs/foundation.css">
    {#<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.16.2/build/highlight.min.js"></script>#}
    <script src="/lib/3dParty/jquery/jquery-1.7.2-unpacked.js"></script>
    <script src="/lib/3dParty/highlight/highlight.min.js"></script>

{% endblock %}

{% block content %}
    <style>
        .main-form .row .error-message .error-message-description {
            color: red;
        }
        pre {
            overflow: visible !important;
        }
        .highlightFileWrap {
            outline: solid 1px #d6dae6;
        }
        @media only screen and (max-width: 1024px) {
            .main-body.responsive .main-blk {
                min-height: 0 !important;
            }
        }
        #sample {
            position: absolute;
        }
        .error div,
        .error span:not(.btn-silver) {
            color: #fff !important;
        }
    </style>

    <script>
        $('document').ready(function () {
            $('#fader').hide();

            $('#div-request').hide();
            $('#div-response').hide();

            const fileChange = function (e) {
                var val = $('#file').val();
                if (val.length === 0) {
                    $('#upload').html('No file choosen');
                } else {
                    var txt = val.match(/\\([^\\]+)$/);
                    if (txt.length === 2)
                        val = txt[1];
                    $('#upload').html(val + "&nbsp;&nbsp;<span style=\"cursor: pointer;font-weight: bold;\" onclick=\"$('#file').val('');$('#upload').html('No file choosen');\">X</span>");
                    $('#sample').prop('selectedIndex', 0);
                }
            };
            $('#file').on('change', fileChange);

            $('#sample').on('change', function () {
                var val = this.selectedIndex;
                if (val !== 0) {
                    $('#file').val('');
                    $('#upload').html('No file choosen');
                }
            });

            $('form#send').submit(function (e) {
                e.preventDefault();

                $('#login-row,#pass-row,#file-row').removeClass('error');

                var login = $('#login').val();
                var pass = $('#pass').val();
                var sample = $('select#sample').find('option:selected').val();

                var file = $('#file').val();
                var inputError = false;
                if (login.length === 0) {
                    $('#login-row').addClass('error');
                    inputError = true;
                }
                if (pass.length === 0) {
                    $('#pass-row').addClass('error');
                    inputError = true;
                }
                if (file.length === 0 && sample.length === 0) {
                    $('#file-row').addClass('error');
                    inputError = true;
                }
                if (inputError)
                    return;
                $('#div-request').show();
                $('#div-response').show();

                $('#fader').show();

                var formData = new FormData(this);
                var url = "{{ path('aw_emailTestParse_send') }}";
                $('#request').html('');
                $('#response').html('Loading...');
                $('#response-viewer').html('');

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    success: function (data) {
                        if (typeof(data.request)) {
                            $('#request').text(JSON.stringify(data.request, null, 4));
                        }
                        if (typeof(data.response)) {
                            $('#fader').hide();
                            if (typeof(data.response.status)) {
                                if (data.response.status === 'queued') {
                                    if (typeof(data.response.requestIds))
                                        checkResult(data.response.requestIds);

                                    else
                                        $('#response').text('Something went wrong. Try again later or contact the support service.');
                                } else {
                                    var jsonResponse = JSON.stringify(data.response, null, 4);
                                    if (data.errorText)
                                        $('#response').text(data.errorText + "\n" + jsonResponse);
                                    else {
                                        $('#response').text(jsonResponse);
                                    }
                                }
                            }
                        }
//                        hljs.initHighlightingOnLoad();
                        return true;
                    },
                    error: function (response) {
                        $('#fader').hide();
                        $('#response').text("Error code: " + response.status + "\n" + JSON.stringify(response.responseJSON, null, 4));
                        return true;
                    },
                    complete: function () {
                        $('html, body').animate({
                            scrollTop: $("#request").offset().top
                        }, 300);
                        $('pre > code').each(function() {
                            hljs.highlightBlock(this);
                        });
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
            });

            function checkResult(ids) {
                $('#fader').show();
                var url = "{{ path('aw_emailTestParse_sendCheck') }}";
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        ids: ids,
                        login: $('#login').val(),
                        pass: $('#pass').val()
                    },
                    headers: {'X-Authentication': $('#login').val() + ':' + $('#password').val()},
                    success: function (response) {
                        if (typeof(response)) {
                            $('#response').text(JSON.stringify(response, null, 4));
                        }
                        $('#fader').hide();
                        return true;
                    },
                    error: function (response) {
                        $('#response').text("Error code: " + response.status + "\n" + JSON.stringify(response.responseJSON, null, 4));
                        $('#fader').hide();
                        return true;
                    },
                    complete: function () {
                        $('#fader').hide();
                        $('html, body').animate({
                            scrollTop: $("#response").offset().top
                        }, 300);
                        $('pre > code').each(function() {
                            hljs.highlightBlock(this);
                        });
                    }
                });
                return false;
            }

            (function emailFileDrop() {
                let dropArea = document.getElementById('file-row');
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false)
                );
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.add('highlightFileWrap'), false)
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlightFileWrap'), false)
                });

                dropArea.addEventListener('drop', (e) => {
                    document.querySelector('#file').files = e.dataTransfer.files;
                    fileChange();
                }, false);
            })();

        });
    </script>
    <div id='fader'
         style="display: block; padding-left: 50%; padding-top: 150px; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; -ms-filter: \'progid:DXImageTransform.Microsoft.Alpha(Opacity=80)\'; filter: alpha(opacity=80); opacity: 0.8; z-index: 1000;">
        <h3>Loading...</h3>
    </div>
    {% include '@AwardWalletMain/Page/_apiNav.html.twig' %}
    <div class="main-blk full-width has-additionl-menu">
        <h1>AwardWallet Email Parsing API Testing Page (v2)</h1>
        <form id="send" action="{{ path('aw_emailTestParse_send') }}" class="main-form" method="post">
            <div class="main-form-item">
                <div class="row" id="login-row">
                    <div class="row-item">
                        <label>Login<span class="required">*</span></label>
                        <div class="input">
                            <div class="input-item">
                                <input type="text" id="login" name="login" value="{{ login }}">
                            </div>
                        </div>
                    </div>
                    <div class="info">
                        <div class="info-icon"></div>
                        <div class="info-description">Use your own credentials if you have them, otherwise, use this
                            “testemail” account
                        </div>
                    </div>
                    <div class="error-message">
                        <div class="warning"><i class="icon-warning-small"></i></div>
                        <div class="error-message-description">This field is required</div>
                    </div>
                </div>
                <div class="row" id="pass-row">
                    <div class="row-item">
                        <label>Password<span class="required">*</span></label>
                        <div class="input">
                            <div class="input-item">
                                <input type="password" id="pass" name="pass" value="{{ pass }}">
                            </div>
                        </div>
                    </div>
                    <div class="info">
                        <div class="info-icon"></div>
                        <div class="info-description"></div>
                    </div>
                    <div class="error-message">
                        <div class="warning"><i class="icon-warning-small"></i></div>
                        <div class="error-message-description">This field is required</div>
                    </div>
                </div>
                <div class="row" id="file-row">
                    <div class="row-item">
                        <label>Email</label>
                        <div class="input">
                            <div class="input-item">
                                <div class="upload-btn">
                                    <input type="file" id="file" name="file"/>
                                    <span class="btn-silver" onclick="$('#file').click();">Choose an .eml file</span>
                                    <span class="upload-btn__file" id="upload">No file choosen</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="info">
                        <div class="info-icon"></div>
                        <div class="info-description">
                            Please choose an .eml file that you want to test
                        </div>
                    </div>
                    <div class="error-message">
                        <div class="warning"><i class="icon-warning-small"></i></div>
                        <div class="error-message-description">This field is required</div>
                    </div>
                </div>
                <div class="row" id="sample-row">
                    <div class="row-item">
                        <label>Sample Emails:</label>
                        <div class="input">
                            <div class="input-item">
                                <div class="styled-select">
                                    <div>
                                        <select style="width: 100%" id="sample" name="sample">
                                            <option value="">Please select a sample email</option>
                                            {% for key,value in files %}
                                                <option value="{{ key }}">{{ value }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="info">
                        <div class="info-icon"></div>
                        <div class="info-description">
                            Alternatively, use one of these sample emails to test different types of itineraries
                        </div>
                    </div>
                    <div class="error-message">
                        <div class="warning"><i class="icon-warning-small"></i></div>
                        <div class="error-message-description">Check something one: file or sample</div>
                    </div>
                </div>
            </div>
            <div class="row-submit">
                <button type="submit" class="btn-blue">Submit</button>
            </div>
        </form>
    </div>
    <div class="main-blk full-width" id="div-request">
        <div class="main-blk-content">
            <div class="title-note">
                <h3>Request</h3>
                <pre>
                    <code class="json" id="request"></code>
                </pre>
            </div>
        </div>
    </div>
    <div class="main-blk full-width" id="div-response">
        <div class="main-blk-content">
            <div class="title-note">
                <h3>Response</h3>
                <pre>
                    <code class="json" id="response"></code>
                </pre>
            </div>
        </div>
    </div>

{% endblock %}
